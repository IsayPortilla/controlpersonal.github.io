<!--<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sitio en Mantenimiento</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .maintenance-container {
            max-width: 800px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #fdbb2d;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(to right, #fdbb2d, #b21f1f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .countdown {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
        }
        
        .countdown-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            min-width: 100px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .countdown-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #fdbb2d;
        }
        
        .countdown-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            opacity: 0.8;
        }
        
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, #fdbb2d, #b21f1f);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .contact-info {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .contact-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #fdbb2d;
        }
        
        .contact-details {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            transition: transform 0.3s ease;
        }
        
        .contact-item:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .contact-icon {
            font-size: 1.2rem;
            color: #fdbb2d;
        }
        
        .social-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .social-link {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            text-decoration: none;
        }
        
        .social-link:hover {
            background: #fdbb2d;
            transform: scale(1.1);
        }
        
        .notification {
            margin-top: 20px;
            padding: 15px;
            background: rgba(253, 187, 45, 0.2);
            border-radius: 10px;
            border-left: 4px solid #fdbb2d;
        }
        
        @media (max-width: 768px) {
            .maintenance-container {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .countdown {
                gap: 10px;
            }
            
            .countdown-item {
                min-width: 70px;
                padding: 10px;
            }
            
            .countdown-value {
                font-size: 2rem;
            }
            
            .contact-details {
                flex-direction: column;
                align-items: center;
            }
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translate(0, 0px); }
            50% { transform: translate(0, 10px); }
            100% { transform: translate(0, -0px); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const MaintenancePage = () => {
            const [timeLeft, setTimeLeft] = useState({
                days: 0,
                hours: 0,
                minutes: 0,
                seconds: 0
            });
            
            const [progress, setProgress] = useState(0);
            
            // Fecha objetivo para la finalizaci칩n del mantenimiento (3 d칤as a partir de ahora)
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + 3);
            targetDate.setHours(targetDate.getHours() + 12);
            
            useEffect(() => {
                const calculateTimeLeft = () => {
                    const now = new Date().getTime();
                    const difference = targetDate - now;
                    
                    if (difference > 0) {
                        setTimeLeft({
                            days: Math.floor(difference / (1000 * 60 * 60 * 24)),
                            hours: Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
                            minutes: Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60)),
                            seconds: Math.floor((difference % (1000 * 60)) / 1000)
                        });
                        
                        // Calcular progreso (suponiendo que el mantenimiento comenz칩 hace 1 d칤a)
                        const totalTime = 4 * 24 * 60 * 60 * 1000; // 4 d칤as en milisegundos
                        const timePassed = totalTime - difference;
                        const progressPercentage = Math.min(100, Math.max(0, (timePassed / totalTime) * 100));
                        setProgress(progressPercentage);
                    }
                };
                
                const timer = setInterval(calculateTimeLeft, 1000);
                
                // Ejecutar inmediatamente al cargar
                calculateTimeLeft();
                
                return () => clearInterval(timer);
            }, []);
            
            return (
                <div className="maintenance-container">
                    <div className="logo floating">
                        <i className="fas fa-tools"></i>
                    </div>
                    
                    <h1>Sitio Web en Mantenimiento</h1>
                    
                    <p className="subtitle">
                        Estamos realizando mejoras importantes en nuestro sitio web para ofrecerte una mejor experiencia. 
                        Volveremos muy pronto con un dise침o renovado y funcionalidades mejoradas.
                    </p>
                    
                    <div className="countdown">
                        <div className="countdown-item">
                            <div className="countdown-value">{timeLeft.days}</div>
                            <div className="countdown-label">D칤as</div>
                        </div>
                        <div className="countdown-item">
                            <div className="countdown-value">{timeLeft.hours}</div>
                            <div className="countdown-label">Horas</div>
                        </div>
                        <div className="countdown-item">
                            <div className="countdown-value">{timeLeft.minutes}</div>
                            <div className="countdown-label">Minutos</div>
                        </div>
                        <div className="countdown-item">
                            <div className="countdown-value">{timeLeft.seconds}</div>
                            <div className="countdown-label">Segundos</div>
                        </div>
                    </div>
                    
                    <div className="progress-container">
                        <div className="progress-bar">
                            <div className="progress" style={{width: `${progress}%`}}></div>
                        </div>
                        <div className="progress-text">
                            <span>Progreso del mantenimiento</span>
                            <span>{Math.round(progress)}%</span>
                        </div>
                    
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MaintenancePage />, document.getElementById('root'));
    </script>
</body>
</html>-->


<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Personal</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-primary: #2c3e50;
            --color-secondary: #3498db;
            --color-light: #ecf0f1;
            --color-admin: #E91E63;
            --color-user: #2196F3;
            --color-oficina: #4CAF50;
            --color-muestreo: #FF9800;
            --color-salidaSR: #F44336;
            --color-salidaCR: #5C6BC0;
            --color-descanso: #9C27B0;
            --color-vacaciones: #009688;
            --color-vacacionesTxt: #795548;
            --color-salida: #607D8B;
            --color-area-muestreo: #FF9800;
            --color-area-rrhh: #9C27B0;
            --color-area-administracion: #2196F3;
            --color-area-direccion: #F44336;
            --color-proyecto: #8BC34A;
            --color-gasto: #FF5722;
            --color-ingreso: #4CAF50;
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 60px;
            --header-height: 60px;
        }


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--color-primary);
            color: white;
            transition: width 0.3s;
            overflow: hidden;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 {
            font-size: 18px;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .sidebar-header h2 {
            display: none;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .sidebar-menu {
            padding: 20px 0;
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
        }

        .menu-section {
            margin-bottom: 20px;
        }

        .menu-title {
            padding: 10px 20px;
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar.collapsed .menu-title {
            display: none;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
            white-space: nowrap;
            overflow: hidden;
            cursor: pointer;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active {
            background-color: var(--color-secondary);
        }

        .menu-icon {
            margin-right: 10px;
            font-size: 18px;
            min-width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .menu-text {
            display: none;
        }

        .menu-badge {
            margin-left: auto;
            background-color: var(--color-secondary);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
        }

        .sidebar.collapsed .menu-badge {
            display: none;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s;
        }

        .main-content.expanded {
            margin-left: var(--sidebar-collapsed-width);
        }

        .header {
            height: var(--header-height);
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-role {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .role-admin {
            background-color: var(--color-admin);
            color: white;
        }

        .role-user {
            background-color: var(--color-user);
            color: white;
        }

        .area-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .area-muestreo {
            background-color: var(--color-area-muestreo);
            color: white;
        }

        .area-rrhh {
            background-color: var(--color-area-rrhh);
            color: white;
        }

        .area-administracion {
            background-color: var(--color-area-administracion);
            color: white;
        }

        .area-direccion {
            background-color: var(--color-area-direccion);
            color: white;
        }

        .content {
            padding: 20px;
        }

        /* Module Styles */
        .module {
            display: none;
        }

        .module.active {
            display: block;
        }

        .module-header {
            margin-bottom: 20px;
        }

        .module-title {
            font-size: 24px;
            color: var(--color-primary);
            margin-bottom: 10px;
        }

        .module-description {
            color: #666;
            margin-bottom: 20px;
        }

        .module-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1a252f;
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-pdf {
            background-color: #F44336;
            color: white;
        }

        .btn-excel {
            background-color: #4CAF50;
            color: white;
        }

        .btn-warning {
            background-color: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        /* Card Styles */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            color: white;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #555;
        }

        .card-content {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .card-footer {
            margin-top: 10px;
            font-size: 14px;
            color: #777;
        }

        /* Table Styles */
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .table-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .table-filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .table-filters select,
        .table-filters input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: var(--color-primary);
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        /* Status Styles */
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
        }

        .status-oficina {
            background-color: var(--color-oficina);
        }

        .status-muestreo {
            background-color: var(--color-muestreo);
        }

        .status-salidaSR {
            background-color: var(--color-salidaSR);
        }

        .status-salidaCR {
            background-color: var(--color-salidaCR);
        }

        .status-descanso {
            background-color: var(--color-descanso);
        }

        .status-vacaciones {
            background-color: var(--color-vacaciones);
        }

        .status-vacacionesTxt {
            background-color: var(--color-vacacionesTxt);
        }

        .status-salida {
            background-color: var(--color-salida);
        }

        .project-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            text-align: center;
            min-width: 80px;
        }

        .status-active {
            background-color: var(--color-proyecto);
        }

        .status-completed {
            background-color: var(--color-secondary);
        }

        .status-cancelled {
            background-color: var(--color-salidaSR);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            color: var(--color-primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Chart Styles */
        .chart-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            height: 400px;
            position: relative;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--color-primary);
        }

        .login-box {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--color-primary);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            color: var(--color-primary);
        }

        /* Estilos para Mi Panel */
        .status-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-button {
            padding: 15px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .status-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .status-button.active {
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--color-primary);
        }

        /* Estilos para formularios de configuraci칩n personal */
        .config-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: var(--color-primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Configuration Styles */
        .config-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .config-section h3 {
            margin-bottom: 15px;
            color: var(--color-primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .permission-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .permission-item h4 {
            margin-bottom: 10px;
            color: var(--color-primary);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        /* Nuevos estilos para tarjetas financieras */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .financial-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .financial-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .card-type {
            font-size: 16px;
            font-weight: bold;
        }

        .card-chip {
            width: 40px;
            height: 30px;
            background: #ffcc00;
            border-radius: 5px;
            position: relative;
        }

        .card-number {
            font-size: 18px;
            letter-spacing: 2px;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .card-details {
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 1;
        }

        .card-balance {
            font-size: 24px;
            font-weight: bold;
            margin-top: 10px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }

        .cash-balance {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }

        .transaction-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .transaction-amount.positive {
            color: #4CAF50;
            font-weight: bold;
        }

        .transaction-amount.negative {
            color: #F44336;
            font-weight: bold;
        }

        /* Nuevos estilos para vista de proyecto */
        .project-detail-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .project-info-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .project-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-primary);
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container-small {
            height: 300px;
        }

        .transactions-section {
            margin-top: 30px;
        }

        .transaction-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: var(--color-secondary);
        }

        .file-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px 0;
        }

        .ticket-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .ticket-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-image {
            max-width: 90%;
            max-height: 80vh;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }

        .back-button {
            margin-bottom: 20px;
        }

        /* Estilos para Vista de Cartas */
        .view-controls {
            display: flex;
            gap: 10px;
            margin-right: auto;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
        }

        /* Vista Grid */
        .cards-grid-view {
            display: none;
        }

        .cards-grid-view.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 10px 0;
        }

        /* Vista Lista */
        .cards-list-view {
            display: none;
        }

        .cards-list-view.active {
            display: block;
        }

        .cards-list-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        .cards-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px 0;
        }

        /* Tarjetas de usuario */
        .user-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid #3498db;
            position: relative;
            overflow: hidden;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .user-card.grid-view {
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .user-card.list-view {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
            padding: 15px 20px;
        }

        .user-card-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .user-card-info {
            flex: 1;
        }

        .user-card-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .user-card-email {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .user-card-area {
            display: inline-block;
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 12px;
            font-size: 12px;
            color: #495057;
            border: 1px solid #e9ecef;
        }

        .user-card-status {
            margin: 10px 0;
        }

        .user-card-current-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            min-width: 100px;
        }

        .user-card-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-card-actions.grid-view {
            margin-top: auto;
        }

        .user-card-actions.list-view {
            flex-direction: row;
            align-items: center;
        }

        .quick-status-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: var(--color-secondary);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
        }

        .quick-status-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .user-card-location {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-card-location::before {
            content: "游늸";
        }

        .user-card-time {
            font-size: 11px;
            color: #aaa;
            text-align: right;
        }

        /* Estados de carga */
        .loading-cards {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .empty-state-cards {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-cards::before {
            content: "游논";
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }

        /* Modal r치pido */
        .quick-modal .modal-content {
            max-width: 500px;
            padding: 25px;
        }

        .quick-status-content {
            text-align: center;
        }

        .current-status-info {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .current-status-info p {
            margin: 8px 0;
            font-size: 15px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .quick-status-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-status-btn-modal {
            padding: 12px 8px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-status-btn-modal:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .user-card.grid-view {
                min-height: 160px;
                padding: 15px;
            }

            .user-card.list-view {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }

            .user-card-actions.list-view {
                justify-content: center;
            }

            .filter-controls {
                flex-direction: column;
                width: 100%;
            }

            .filter-controls select {
                min-width: 100%;
            }

            .view-controls {
                width: 100%;
                justify-content: center;
            }

            .module-actions {
                gap: 15px;
            }

            .quick-status-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-status-btn-modal {
                min-height: 45px;
                font-size: 12px;
            }

            .user-card-name {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .cards-grid {
                gap: 10px;
            }

            .user-card {
                padding: 12px;
            }

            .quick-status-buttons {
                grid-template-columns: 1fr;
            }

            .user-card-actions.grid-view {
                flex-direction: column;
            }

            .quick-status-btn {
                padding: 10px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1025px) and (max-width: 1440px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1441px) {
            .cards-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Estados de usuario en las tarjetas */
        .user-card.status-oficina {
            border-left-color: var(--color-oficina);
        }

        .user-card.status-muestreo {
            border-left-color: var(--color-muestreo);
        }

        .user-card.status-salidaSR {
            border-left-color: var(--color-salidaSR);
        }

        .user-card.status-salidaCR {
            border-left-color: var(--color-salidaCR);
        }

        .user-card.status-descanso {
            border-left-color: var(--color-descanso);
        }

        .user-card.status-vacaciones {
            border-left-color: var(--color-vacaciones);
        }

        .user-card.status-vacacionesTxt {
            border-left-color: var(--color-vacacionesTxt);
        }

        .user-card.status-salida {
            border-left-color: var(--color-salida);
        }

        /* Animaciones */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-card {
            animation: fadeIn 0.3s ease-out;
        }

        /* Efectos de hover mejorados */
        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .user-card:hover::before {
            left: 100%;
        }

        /* Scroll personalizado para lista */
        .cards-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .cards-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .cards-list-container::-webkit-scrollbar-thumb {
            background: var(--color-secondary);
            border-radius: 3px;
        }

        .cards-list-container::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                width: var(--sidebar-collapsed-width);
            }

            .sidebar.collapsed {
                width: 0;
            }

            .main-content {
                margin-left: var(--sidebar-collapsed-width);
            }

            .main-content.expanded {
                margin-left: 0;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            .table-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .header-right {
                flex-direction: column;
                gap: 5px;
                align-items: flex-end;
            }

            .permissions-grid {
                grid-template-columns: 1fr;
            }

            .card-container {
                grid-template-columns: 1fr;
            }

            .project-detail-container {
                grid-template-columns: 1fr;
            }

            .chart-row {
                grid-template-columns: 1fr;
            }

            .project-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">Sistema de Control</div>
            <h2 class="login-title">Iniciar Sesi칩n</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contrase침a</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesi칩n</button>
                </div>
                <div id="loginError" class="error-message"
                    style="color: #e74c3c; text-align: center; margin-top: 10px;"></div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Sistema de Control</h2>
                <button class="toggle-sidebar" id="toggleSidebar">驕</button>
            </div>
            <div class="sidebar-menu">
                <!-- Dashboard Section -->
                <div class="menu-section">
                    <div class="menu-title">Principal</div>
                    <a href="#" class="menu-item active" data-module="dashboard">
                        <span class="menu-icon">游늵</span>
                        <span class="menu-text">Dashboard</span>
                    </a>
                </div>

                <!-- Personal Section -->
                <div class="menu-section">
                    <div class="menu-title">Personal</div>
                    <a href="#" class="menu-item" data-module="personal">
                        <span class="menu-icon">游논</span>
                        <span class="menu-text">Control de Personal</span>
                    </a>
                    <a href="#" class="menu-item" data-module="usuarios">
                        <span class="menu-icon">游녻</span>
                        <span class="menu-text">Gesti칩n de Usuarios</span>
                    </a>
                    <a href="#" class="menu-item" data-module="movimientos">
                        <span class="menu-icon">游댃</span>
                        <span class="menu-text">Movimientos</span>
                    </a>
                    <div class="menu-title">Vista R치pida</div>
                    <a href="#" class="menu-item" data-module="vista-cartas">
                        <span class="menu-icon">游</span>
                        <span class="menu-text">Vista de Cartas</span>
                    </a>
                </div>

                <!--CONFIGURACION Y VISUALIZACION DE USUARIOS-->
                <div class="menu-section">
                    <div class="menu-title">Mi Panel</div>
                    <a href="#" class="menu-item" data-module="mi-panel">
                        <span class="menu-icon">游녻</span>
                        <span class="menu-text">Mi Panel</span>
                    </a>
                    <a href="#" class="menu-item" data-module="mi-configuracion">
                        <span class="menu-icon">丘뙖잺</span>
                        <span class="menu-text">Mi Configuraci칩n</span>
                    </a>
                </div>


                <!-- Projects Section -->
                <div class="menu-section">
                    <div class="menu-title">Proyectos</div>
                    <a href="#" class="menu-item" data-module="proyectos">
                        <span class="menu-icon">游늶</span>
                        <span class="menu-text">Gesti칩n de Proyectos</span>
                    </a>
                    <a href="#" class="menu-item" data-module="finanzas">
                        <span class="menu-icon">游눯</span>
                        <span class="menu-text">Control Financiero</span>
                    </a>
                </div>

                <!-- Configuration Section -->
                <div class="menu-section">
                    <div class="menu-title">Configuraci칩n</div>
                    <a href="#" class="menu-item" data-module="areas">
                        <span class="menu-icon">游끽</span>
                        <span class="menu-text">츼reas</span>
                    </a>
                    <a href="#" class="menu-item" data-module="configuracion">
                        <span class="menu-icon">丘뙖잺</span>
                        <span class="menu-text">Configuraci칩n General</span>
                    </a>
                    <a href="#" class="menu-item" data-module="configuracion-modulos">
                        <span class="menu-icon">游</span>
                        <span class="menu-text">Permisos de M칩dulos</span>
                    </a>
                </div>

                <!-- Menu General Section -->
                <div class="menu-section">
                    <div class="menu-title">Men칰 General</div>
                    <a href="#" class="menu-item" data-module="menu-general">
                        <span class="menu-icon">游듺勇</span>
                        <span class="menu-text">Men칰 General</span>
                    </a>
                </div>
            </div>
        </div>


        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <h1 class="header-title" id="moduleTitle">Dashboard</h1>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span id="userEmail"></span>
                        <span id="userRoleBadge" class="user-role"></span>
                        <span id="userAreaBadge" class="area-badge"></span>
                    </div>
                    <button id="btnLogout" class="btn btn-danger">Cerrar Sesi칩n</button>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Dashboard Module -->
                <div id="dashboard-module" class="module active">
                    <div class="module-header">
                        <h2 class="module-title">Dashboard</h2>
                        <p class="module-description">Resumen general del sistema de control de personal</p>
                    </div>

                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-primary);">游논</div>
                                <div class="card-title">Total Usuarios</div>
                            </div>
                            <div class="card-content" id="totalUsers">0</div>
                            <div class="card-footer">Usuarios registrados en el sistema</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-oficina);">游끽</div>
                                <div class="card-title">En Oficina</div>
                            </div>
                            <div class="card-content" id="usersInOffice">0</div>
                            <div class="card-footer">Usuarios actualmente en oficina</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-muestreo);">游댧</div>
                                <div class="card-title">En Muestreo</div>
                            </div>
                            <div class="card-content" id="usersSampling">0</div>
                            <div class="card-footer">Usuarios en trabajo de campo</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-proyecto);">游늶</div>
                                <div class="card-title">Proyectos Activos</div>
                            </div>
                            <div class="card-content" id="activeProjects">0</div>
                            <div class="card-footer">Proyectos en ejecuci칩n</div>
                        </div>
                    </div>

                    <div class="module-actions">
                        <button class="btn btn-primary" onclick="cargarUsuarios()">Actualizar Datos</button>
                        <button class="btn btn-secondary" onclick="generarPDF('dashboard')">Generar Reporte PDF</button>
                        <button class="btn btn-success" onclick="generarExcel('dashboard')">Generar Reporte
                            Excel</button>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Estado Actual del Personal</h3>
                            <div class="table-filters">
                                <select id="dashboardAreaFilter">
                                    <option value="todos">Todas las 치reas</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>츼rea</th>
                                    <th>Estado</th>
                                    <th>칔ltima Actualizaci칩n</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 20px;">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Personal Module -->
                <div id="personal-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Control de Personal</h2>
                        <p class="module-description">Gesti칩n y seguimiento del estado del personal</p>
                    </div>

                    <div class="module-actions">
                        <button class="btn btn-primary" onclick="cargarUsuarios()">Actualizar</button>
                        <button class="btn btn-secondary" onclick="generarPDF('personal')">Generar PDF</button>
                        <button class="btn btn-success" onclick="generarExcel('personal')">Generar Excel</button>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Personal</h3>
                            <div class="table-filters">
                                <select id="personalAreaFilter">
                                    <option value="todos">Todas las 치reas</option>
                                </select>
                                <select id="personalStatusFilter">
                                    <option value="todos">Todos los estados</option>
                                    <option value="oficina">Oficina</option>
                                    <option value="muestreo">Muestreo</option>
                                    <option value="salidaSR">Salida Intermitente</option>
                                    <option value="salidaCR">Salida con regreso</option>
                                    <option value="descanso">Descanso</option>
                                    <option value="vacaciones">Vacaciones</option>
                                    <option value="vacacionesTxt">Permiso TxT</option>
                                    <option value="salida">Salida</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>츼rea</th>
                                    <th>Estado</th>
                                    <th>칔ltima Actualizaci칩n</th>
                                    <th>Ubicaci칩n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="personal-table-body">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px;">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mi Panel Module -->
                <div id="mi-panel-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Mi Panel</h2>
                        <p class="module-description">Gestiona tu estado y visualiza tus proyectos asignados</p>
                    </div>

                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-oficina);">游끽</div>
                                <div class="card-title">Mi Estado Actual</div>
                            </div>
                            <div class="card-content" id="myCurrentStatus">Cargando...</div>
                            <div class="card-footer" id="myLastUpdate">칔ltima actualizaci칩n: --</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-proyecto);">游늶</div>
                                <div class="card-title">Mis Proyectos</div>
                            </div>
                            <div class="card-content" id="myProjectsCount">0</div>
                            <div class="card-footer">Proyectos asignados</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-secondary);">游늸</div>
                                <div class="card-title">Mi Ubicaci칩n</div>
                            </div>
                            <div class="card-content" id="myLocation">No disponible</div>
                            <div class="card-footer">Ubicaci칩n actual</div>
                        </div>
                    </div>

                    <div class="module-actions">
                        <h3>Cambiar Mi Estado</h3>
                        <div class="status-buttons" id="statusButtons">
                            <!-- Los botones se generar치n din치micamente -->
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Mis Proyectos Asignados</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>L칤der</th>
                                    <th>Estado</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="my-projects-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px;">Cargando proyectos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                <div id="vista-cartas-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Vista de Cartas - Control de Estado</h2>
                        <p class="module-description">Cambio r치pido de estado para todo el personal de muestreo</p>
                    </div>

                    <div class="module-actions">
                        <div class="view-controls">
                            <button class="btn btn-secondary active" data-view="grid" onclick="changeView('grid')">
                                <span class="mobile-hidden">Vista Grid</span>
                                <span class="mobile-only">낓勇</span>
                            </button>
                            <button class="btn btn-secondary" data-view="list" onclick="changeView('list')">
                                <span class="mobile-hidden">Vista Lista</span>
                                <span class="mobile-only">游늶</span>
                            </button>
                        </div>
                        <div class="filter-controls">
                            <select id="cardsAreaFilter" onchange="loadUsersCards()">
                                <option value="todos">Todas las 치reas</option>
                            </select>
                            <select id="cardsStatusFilter" onchange="loadUsersCards()">
                                <option value="todos">Todos los estados</option>
                                <option value="oficina">Oficina</option>
                                <option value="muestreo">Muestreo</option>
                                <option value="salidaSR">Salida Intermitente</option>
                                <option value="salidaCR">Salida con regreso</option>
                                <option value="descanso">Descanso</option>
                                <option value="vacaciones">Vacaciones</option>
                                <option value="vacacionesTxt">Permiso TxT</option>
                                <option value="salida">Salida</option>
                            </select>
                            <button class="btn btn-primary" onclick="loadUsersCards()">
                                <span class="mobile-hidden">Actualizar</span>
                                <span class="mobile-only">游댃</span>
                            </button>
                        </div>
                    </div>

                    <!-- Vista Grid -->
                    <div id="cardsGridView" class="cards-grid-view active">
                        <div class="cards-grid" id="usersCardsGrid">
                            <div class="loading-cards">
                                <div class="loading-spinner"></div>
                                <p>Cargando usuarios...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Vista Lista -->
                    <div id="cardsListView" class="cards-list-view">
                        <div class="cards-list-container">
                            <div class="cards-list" id="usersCardsList">
                                <div class="loading-cards">
                                    <div class="loading-spinner"></div>
                                    <p>Cargando usuarios...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal r치pido de cambio de estado -->
                    <div id="quickStatusModal" class="modal quick-modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title" id="quickStatusUserName">Cambiar Estado</h3>
                                <button class="close-modal" onclick="closeQuickStatusModal()">&times;</button>
                            </div>
                            <div class="quick-status-content">
                                <div class="current-status-info">
                                    <p>Estado actual: <span id="currentUserStatus" class="status-badge"></span></p>
                                    <p id="currentUserLocation">Ubicaci칩n: Cargando...</p>
                                </div>
                                <div class="quick-status-buttons" id="quickStatusButtons">
                                    <!-- Los botones se generar치n din치micamente -->
                                </div>
                                <div class="quick-actions">
                                    <button class="btn btn-secondary" onclick="getCurrentLocation()">
                                        <span class="mobile-hidden">Actualizar Ubicaci칩n</span>
                                        <span class="mobile-only">游늸 Ubicaci칩n</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Mi Configuraci칩n Module -->
                <div id="mi-configuracion-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Mi Configuraci칩n</h2>
                        <p class="module-description">Gestiona tu informaci칩n personal y preferencias</p>
                    </div>

                    <div class="config-section">
                        <h3>Informaci칩n Personal</h3>
                        <form id="myProfileForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="myProfileName">Nombre</label>
                                    <input type="text" id="myProfileName" required>
                                </div>
                                <div class="form-group">
                                    <label for="myProfileLastName">Apellido Paterno</label>
                                    <input type="text" id="myProfileLastName" required>
                                </div>
                                <div class="form-group">
                                    <label for="myProfileMotherLastName">Apellido Materno</label>
                                    <input type="text" id="myProfileMotherLastName">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="myProfileEmail">Email</label>
                                    <input type="email" id="myProfileEmail" required readonly>
                                </div>
                                <div class="form-group">
                                    <label for="myProfileArea">츼rea</label>
                                    <input type="text" id="myProfileArea" readonly>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>

                    <div class="config-section">
                        <h3>Cambiar Contrase침a</h3>
                        <form id="myPasswordForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="myCurrentPassword">Contrase침a Actual</label>
                                    <input type="password" id="myCurrentPassword" required>
                                </div>
                                <div class="form-group">
                                    <label for="myNewPassword">Nueva Contrase침a</label>
                                    <input type="password" id="myNewPassword" required>
                                </div>
                                <div class="form-group">
                                    <label for="myConfirmPassword">Confirmar Nueva Contrase침a</label>
                                    <input type="password" id="myConfirmPassword" required>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Cambiar Contrase침a</button>
                            </div>
                        </form>
                    </div>

                    <div class="config-section">
                        <h3>Preferencias</h3>
                        <div class="form-group">
                            <label for="myNotifications">Notificaciones por Email</label>
                            <input type="checkbox" id="myNotifications" checked>
                        </div>
                        <div class="form-group">
                            <label for="myLanguage">Idioma</label>
                            <select id="myLanguage">
                                <option value="es">Espa침ol</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="saveMyPreferences()">Guardar Preferencias</button>
                        </div>
                    </div>
                </div>

                <!-- Usuarios Module -->
                <div id="usuarios-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Gesti칩n de Usuarios</h2>
                        <p class="module-description">Administraci칩n de usuarios del sistema</p>
                    </div>

                    <div class="module-actions">
                        <button class="btn btn-primary" onclick="showUserModal()">Agregar Usuario</button>
                        <button class="btn btn-secondary" onclick="cargarUsuariosParaEdicion()">Actualizar
                            Lista</button>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Usuarios del Sistema</h3>
                            <div class="table-filters">
                                <select id="usuariosAreaFilter">
                                    <option value="todos">Todas las 치reas</option>
                                </select>
                                <select id="usuariosRoleFilter">
                                    <option value="todos">Todos los roles</option>
                                    <option value="administrador">Administrador</option>
                                    <option value="usuario">Usuario</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>츼rea</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usuarios-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px;">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Movimientos Module -->
                <div id="movimientos-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Movimientos de Personal</h2>
                        <p class="module-description">Historial de cambios de estado del personal</p>
                    </div>

                    <div class="module-actions">
                        <div class="table-filters">
                            <input type="date" id="movementStartDate">
                            <input type="date" id="movementEndDate">
                            <button class="btn btn-primary" onclick="cargarMovimientos()">Filtrar</button>
                            <button class="btn btn-secondary" onclick="generarPDF('movimientos')">Generar PDF</button>
                            <button class="btn btn-success" onclick="generarExcel('movimientos')">Generar Excel</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>츼rea</th>
                                    <th>Estado Anterior</th>
                                    <th>Estado Nuevo</th>
                                    <th>Fecha Cambio</th>
                                    <th>Ubicaci칩n</th>
                                    <th>Responsable</th>
                                </tr>
                            </thead>
                            <tbody id="movimientos-table-body">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px;">Seleccione filtros para
                                        ver los movimientos</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Proyectos Module -->
                <div id="proyectos-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Gesti칩n de Proyectos</h2>
                        <p class="module-description">Administraci칩n de proyectos y su seguimiento</p>
                    </div>

                    <div class="module-actions">
                        <button class="btn btn-primary" onclick="showProjectModal()">Nuevo Proyecto</button>
                        <button class="btn btn-secondary" onclick="loadProjects()">Actualizar Lista</button>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Proyectos</h3>
                            <div class="table-filters">
                                <select id="proyectosStatusFilter">
                                    <option value="todos">Todos los estados</option>
                                    <option value="active">Activos</option>
                                    <option value="completed">Completados</option>
                                    <option value="cancelled">Cancelados</option>
                                </select>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>L칤der</th>
                                    <th>Estado</th>
                                    <th>Presupuesto</th>
                                    <th>Gastos</th>
                                    <th>Saldo</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="proyectos-table-body">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 20px;">Cargando proyectos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vista Detallada de Proyecto -->
                <div id="project-detail-module" class="module">
                    <div class="module-header">
                        <button class="btn btn-secondary back-button" onclick="switchModule('proyectos')"> Volver a
                            Proyectos</button>
                        <h2 class="module-title" id="projectDetailTitle">Detalle del Proyecto</h2>
                        <p class="module-description" id="projectDetailDescription"></p>
                    </div>

                    <div class="project-detail-container">
                        <div class="project-info-card">
                            <h3>Informaci칩n del Proyecto</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>L칤der del Proyecto</label>
                                    <p id="projectDetailLeader"></p>
                                </div>
                                <div class="form-group">
                                    <label>Estado</label>
                                    <p id="projectDetailStatus"></p>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Fecha de Inicio</label>
                                    <p id="projectDetailStartDate"></p>
                                </div>
                                <div class="form-group">
                                    <label>Fecha de Fin</label>
                                    <p id="projectDetailEndDate"></p>
                                </div>
                            </div>

                            <div class="project-stats">
                                <div class="stat-card">
                                    <div class="stat-value" id="projectBudget">$0.00</div>
                                    <div class="stat-label">Presupuesto</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="projectExpenses">$0.00</div>
                                    <div class="stat-label">Gastos Totales</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="projectBalance">$0.00</div>
                                    <div class="stat-label">Saldo Restante</div>
                                </div>
                            </div>
                        </div>

                        <div class="project-info-card">
                            <h3>Resumen Financiero</h3>
                            <div class="chart-container-small">
                                <canvas id="projectExpenseChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="chart-row">
                        <div class="chart-container">
                            <canvas id="projectCategoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="projectTimelineChart"></canvas>
                        </div>
                    </div>

                    <div class="transactions-section">
                        <div class="table-header">
                            <h3 class="table-title">Transacciones del Proyecto</h3>
                            <button class="btn btn-primary" onclick="showTransactionModal()">Agregar
                                Transacci칩n</button>
                        </div>

                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Descripci칩n</th>
                                        <th>Categor칤a</th>
                                        <th>Tipo</th>
                                        <th>Monto</th>
                                        <th>M칠todo de Pago</th>
                                        <th>Comprobante</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="project-transactions-body">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 20px;">Cargando
                                            transacciones...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="module-actions">
                        <button class="btn btn-success" onclick="generateProjectReport('pdf')">Generar Reporte
                            PDF</button>
                        <button class="btn btn-excel" onclick="generateProjectReport('excel')">Generar Reporte
                            Excel</button>
                        <button class="btn btn-warning" onclick="closeProject()">Cerrar Proyecto</button>
                    </div>
                </div>

                <!-- Finanzas Module -->
                <div id="finanzas-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Control Financiero</h2>
                        <p class="module-description">Seguimiento financiero de proyectos y gesti칩n de fondos</p>
                    </div>

                    <div class="module-actions">
                        <button class="btn btn-primary" onclick="showCardModal()">Agregar Tarjeta</button>
                        <button class="btn btn-secondary" onclick="showAddFundsModal()">Agregar Fondos</button>
                        <button class="btn btn-warning" onclick="showWithdrawModal()">Retirar Efectivo</button>
                        <button class="btn btn-success" onclick="loadFinancialData()">Actualizar</button>
                    </div>

                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-ingreso);">游눯</div>
                                <div class="card-title">Total Ingresos</div>
                            </div>
                            <div class="card-content" id="totalIncome">$0.00</div>
                            <div class="card-footer">Ingresos totales de todos los proyectos</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-gasto);">游눶</div>
                                <div class="card-title">Total Gastos</div>
                            </div>
                            <div class="card-content" id="totalExpense">$0.00</div>
                            <div class="card-footer">Gastos totales de todos los proyectos</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-secondary);">游늵</div>
                                <div class="card-title">Saldo Total</div>
                            </div>
                            <div class="card-content" id="totalBalance">$0.00</div>
                            <div class="card-footer">Saldo general del sistema</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: #9C27B0;">游눳</div>
                                <div class="card-title">Efectivo Disponible</div>
                            </div>
                            <div class="card-content" id="availableCash">$0.00</div>
                            <div class="card-footer">Efectivo disponible para proyectos</div>
                        </div>
                    </div>

                    <div class="card-container" id="cardsContainer">
                        <!-- Las tarjetas se cargar치n din치micamente aqu칤 -->
                    </div>

                    <div class="chart-container">
                        <canvas id="financialChart"></canvas>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Historial de Transacciones</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripci칩n</th>
                                    <th>Tipo</th>
                                    <th>Monto</th>
                                    <th>Tarjeta/Fuente</th>
                                    <th>Proyecto</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 20px;">Cargando transacciones...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Areas Module -->
                <div id="areas-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Gesti칩n de 츼reas</h2>
                        <p class="module-description">Administraci칩n de 치reas organizacionales</p>
                    </div>

                    <div class="module-actions">
                        <button class="btn btn-primary" onclick="showAreaModal()">Agregar 츼rea</button>
                        <button class="btn btn-secondary" onclick="cargarAreas()">Actualizar Lista</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Color</th>
                                    <th>N칰mero de Usuarios</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="areas-table-body">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 20px;">Cargando 치reas...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Configuraci칩n General Module -->
                <div id="configuracion-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Configuraci칩n del Sistema</h2>
                        <p class="module-description">Ajustes y preferencias del sistema</p>
                    </div>

                    <div class="config-section">
                        <h3>Configuraci칩n General</h3>
                        <div class="form-group">
                            <label for="systemName">Nombre del Sistema</label>
                            <input type="text" id="systemName" class="form-control"
                                value="Sistema de Control de Personal">
                        </div>
                        <div class="form-group">
                            <label for="systemEmail">Email del Sistema</label>
                            <input type="email" id="systemEmail" class="form-control" value="sistema@empresa.com">
                        </div>
                        <div class="form-group">
                            <label for="reportPeriod">Per칤odo de Reportes por Defecto</label>
                            <select id="reportPeriod" class="form-control">
                                <option value="diario">Diario</option>
                                <option value="semanal" selected>Semanal</option>
                                <option value="mensual">Mensual</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="guardarConfiguracionSistema()">Guardar
                                Configuraci칩n</button>
                        </div>
                    </div>
                </div>

                <!-- Configuraci칩n de M칩dulos Module -->
                <div id="configuracion-modulos-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Configuraci칩n de Permisos de M칩dulos</h2>
                        <p class="module-description">Gesti칩n de permisos de acceso a m칩dulos por rol y 치rea</p>
                    </div>

                    <div class="config-section">
                        <h3>Permisos por M칩dulo</h3>
                        <p>Configure qu칠 roles y 치reas pueden acceder a cada m칩dulo del sistema.</p>

                        <div class="permissions-grid" id="modulesPermissionsGrid">
                            <!-- Se llenar치 din치micamente con JavaScript -->
                        </div>

                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="guardarConfiguracionModulos()">Guardar
                                Configuraci칩n de M칩dulos</button>
                        </div>
                    </div>
                </div>

                <!-- Menu General Module -->
                <div id="menu-general-module" class="module">
                    <div class="module-header">
                        <h2 class="module-title">Men칰 General</h2>
                        <p class="module-description">Acceso r치pido a todas las funcionalidades del sistema</p>
                    </div>

                    <div class="dashboard-cards">
                        <div class="card" onclick="switchModule('dashboard')" style="cursor: pointer;">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-primary);">游늵</div>
                                <div class="card-title">Dashboard</div>
                            </div>
                            <div class="card-content">Resumen General</div>
                            <div class="card-footer">Vista general del sistema</div>
                        </div>

                        <div class="card" onclick="switchModule('personal')" style="cursor: pointer;">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-oficina);">游논</div>
                                <div class="card-title">Control de Personal</div>
                            </div>
                            <div class="card-content">Gesti칩n de Estados</div>
                            <div class="card-footer">Seguimiento del personal</div>
                        </div>

                        <div class="card" onclick="switchModule('usuarios')" style="cursor: pointer;">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-user);">游녻</div>
                                <div class="card-title">Gesti칩n de Usuarios</div>
                            </div>
                            <div class="card-content">Administraci칩n</div>
                            <div class="card-footer">Gesti칩n de usuarios del sistema</div>
                        </div>

                        <div class="card" onclick="switchModule('movimientos')" style="cursor: pointer;">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-secondary);">游댃</div>
                                <div class="card-title">Movimientos</div>
                            </div>
                            <div class="card-content">Historial</div>
                            <div class="card-footer">Registro de cambios de estado</div>
                        </div>

                        <div class="card" onclick="switchModule('proyectos')" style="cursor: pointer;">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-proyecto);">游늶</div>
                                <div class="card-title">Proyectos</div>
                            </div>
                            <div class="card-content">Gesti칩n</div>
                            <div class="card-footer">Administraci칩n de proyectos</div>
                        </div>

                        <div class="card" onclick="switchModule('finanzas')" style="cursor: pointer;">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-ingreso);">游눯</div>
                                <div class="card-title">Finanzas</div>
                            </div>
                            <div class="card-content">Control</div>
                            <div class="card-footer">Seguimiento financiero</div>
                        </div>

                        <div class="card" onclick="switchModule('areas')" style="cursor: pointer;">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-area-administracion);">游끽
                                </div>
                                <div class="card-title">츼reas</div>
                            </div>
                            <div class="card-content">Organizaci칩n</div>
                            <div class="card-footer">Gesti칩n de 치reas</div>
                        </div>

                        <div class="card" onclick="switchModule('configuracion')" style="cursor: pointer;">
                            <div class="card-header">
                                <div class="card-icon" style="background-color: var(--color-admin);">丘뙖잺</div>
                                <div class="card-title">Configuraci칩n</div>
                            </div>
                            <div class="card-content">Sistema</div>
                            <div class="card-footer">Configuraci칩n general</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Agregar Usuario</h3>
                <button class="close-modal" onclick="closeUserModal()">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="editUserId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="userNombre">Nombre</label>
                        <input type="text" id="userNombre" required>
                    </div>
                    <div class="form-group">
                        <label for="userApellidoPaterno">Apellido Paterno</label>
                        <input type="text" id="userApellidoPaterno" required>
                    </div>
                    <div class="form-group">
                        <label for="userApellidoMaterno">Apellido Materno</label>
                        <input type="text" id="userApellidoMaterno">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="userArea">츼rea</label>
                        <select id="userArea" required>
                            <option value="">Seleccione un 치rea</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="userPassword">Contrase침a</label>
                        <input type="password" id="userPassword">
                    </div>
                    <div class="form-group">
                        <label for="userStatus">Estado inicial</label>
                        <select id="userStatus" required>
                            <option value="oficina">Oficina</option>
                            <option value="muestreo">Muestreo</option>
                            <option value="salidaSR">Salida Intermitente</option>
                            <option value="salidaCR">Salida con regreso</option>
                            <option value="descanso">Descanso</option>
                            <option value="vacaciones">Vacaciones</option>
                            <option value="vacacionesTxt">Permiso TxT</option>
                            <option value="salida">Salida</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userRole">Rol de usuario</label>
                        <select id="userRole" required>
                            <option value="usuario">Usuario</option>
                            <option value="administrador">Administrador</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeUserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">Nuevo Proyecto</h3>
                <button class="close-modal" onclick="closeProjectModal()">&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="editProjectId">
                <div class="form-group">
                    <label for="projectName">Nombre del Proyecto</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label for="projectDescription">Descripci칩n</label>
                    <textarea id="projectDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="projectLeader">L칤der del Proyecto</label>
                        <select id="projectLeader" required>
                            <option value="">Seleccione un l칤der</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectBudget">Presupuesto</label>
                        <input type="number" id="projectBudget" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="projectStartDate">Fecha de Inicio</label>
                        <input type="date" id="projectStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="projectEndDate">Fecha de Finalizaci칩n</label>
                        <input type="date" id="projectEndDate">
                    </div>
                </div>
                <div class="form-group">
                    <label for="projectParticipants">Participantes</label>
                    <select id="projectParticipants" multiple>
                        <!-- Se llenar치 con usuarios disponibles -->
                    </select>
                    <small>Mant칠n presionada la tecla Ctrl (Cmd en Mac) para seleccionar m칰ltiples participantes</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeProjectModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Proyecto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Area Modal -->
    <div id="areaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="areaModalTitle">Agregar 츼rea</h3>
                <button class="close-modal" onclick="closeAreaModal()">&times;</button>
            </div>
            <form id="areaForm">
                <input type="hidden" id="editAreaId">
                <div class="form-group">
                    <label for="areaName">Nombre del 츼rea</label>
                    <input type="text" id="areaName" required>
                </div>
                <div class="form-group">
                    <label for="areaColor">Color</label>
                    <input type="color" id="areaColor" value="#3498db" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeAreaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar 츼rea</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Tarjetas -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="cardModalTitle">Agregar Tarjeta</h3>
                <button class="close-modal" onclick="closeCardModal()">&times;</button>
            </div>
            <form id="cardForm">
                <input type="hidden" id="editCardId">
                <div class="form-group">
                    <label for="cardName">Nombre de la Tarjeta</label>
                    <input type="text" id="cardName" required>
                </div>
                <div class="form-group">
                    <label for="cardNumber">N칰mero de Tarjeta</label>
                    <input type="text" id="cardNumber" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cardType">Tipo de Tarjeta</label>
                        <select id="cardType" required>
                            <option value="debito">D칠bito</option>
                            <option value="credito">Cr칠dito</option>
                            <option value="prepago">Prepago</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cardBank">Banco</label>
                        <input type="text" id="cardBank" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cardBalance">Saldo Inicial</label>
                        <input type="number" id="cardBalance" step="0.01" min="0" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="cardColor">Color</label>
                        <input type="color" id="cardColor" value="#3498db" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeCardModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Tarjeta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Agregar Fondos -->
    <div id="addFundsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Agregar Fondos</h3>
                <button class="close-modal" onclick="closeAddFundsModal()">&times;</button>
            </div>
            <form id="addFundsForm">
                <div class="form-group">
                    <label for="fundsCard">Seleccionar Tarjeta</label>
                    <select id="fundsCard" required>
                        <option value="">Seleccione una tarjeta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fundsAmount">Monto a Agregar</label>
                    <input type="number" id="fundsAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="fundsDescription">Descripci칩n</label>
                    <input type="text" id="fundsDescription" placeholder="Ej: Dep칩sito de n칩mina">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeAddFundsModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Fondos</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Retirar Efectivo -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Retirar Efectivo</h3>
                <button class="close-modal" onclick="closeWithdrawModal()">&times;</button>
            </div>
            <form id="withdrawForm">
                <div class="form-group">
                    <label for="withdrawCard">Seleccionar Tarjeta</label>
                    <select id="withdrawCard" required>
                        <option value="">Seleccione una tarjeta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdrawAmount">Monto a Retirar</label>
                    <input type="number" id="withdrawAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="withdrawDescription">Descripci칩n</label>
                    <input type="text" id="withdrawDescription" placeholder="Ej: Retiro para gastos de proyecto">
                </div>
                <div class="form-group">
                    <label for="withdrawProject">Asignar a Proyecto (Opcional)</label>
                    <select id="withdrawProject">
                        <option value="">Seleccione un proyecto</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeWithdrawModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Retirar Efectivo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Transacciones -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="transactionModalTitle">Agregar Transacci칩n</h3>
                <button class="close-modal" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="editTransactionId">
                <input type="hidden" id="transactionProjectId">

                <div class="form-row">
                    <div class="form-group">
                        <label for="transactionType">Tipo de Transacci칩n</label>
                        <select id="transactionType" required onchange="toggleTransactionFields()">
                            <option value="ingreso">Ingreso</option>
                            <option value="gasto">Gasto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transactionCategory">Categor칤a</label>
                        <select id="transactionCategory" required>
                            <!-- Se llenar치 din치micamente -->
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="transactionAmount">Monto</label>
                        <input type="number" id="transactionAmount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="transactionDate">Fecha</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="transactionDescription">Descripci칩n</label>
                    <textarea id="transactionDescription" rows="3" required></textarea>
                </div>

                <div class="form-row" id="paymentMethodSection">
                    <div class="form-group">
                        <label for="transactionPaymentMethod">M칠todo de Pago</label>
                        <select id="transactionPaymentMethod" onchange="toggleCardSelection()">
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="transferencia">Transferencia</option>
                        </select>
                    </div>
                    <div class="form-group" id="cardSelectionSection" style="display: none;">
                        <label for="transactionCard">Seleccionar Tarjeta</label>
                        <select id="transactionCard">
                            <option value="">Seleccione una tarjeta</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Comprobante (Opcional)</label>
                    <div class="file-upload" onclick="document.getElementById('transactionFile').click()">
                        <p>Haz clic para subir comprobante</p>
                        <small>Formatos: JPG, PNG, PDF (M치x. 5MB)</small>
                    </div>
                    <input type="file" id="transactionFile" accept=".jpg,.jpeg,.png,.pdf" style="display: none;"
                        onchange="previewTransactionFile()">
                    <div id="filePreview"></div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-danger" onclick="closeTransactionModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Transacci칩n</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Ver Imagen -->
    <div id="imageModal" class="modal">
        <div class="modal-content" style="max-width: 90%; text-align: center;">
            <div class="modal-header">
                <h3 class="modal-title">Comprobante</h3>
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
            <img id="modalImage" class="modal-image" src="" alt="Comprobante">
        </div>
    </div>

    <script>
        // Configuraci칩n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD2AKLkOppM52EXtd0asaejb0cuBAi679M",
            authDomain: "controlmuestreo.firebaseapp.com",
            projectId: "controlmuestreo",
            storageBucket: "controlmuestreo.firebasestorage.app",
            messagingSenderId: "1016282431379",
            appId: "1:1016282431379:web:8c256ced964eba0913f266",
            measurementId: "G-12PSN98LQH"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Variables globales
        let currentUser = null;
        let currentUserRole = null;
        let currentUserArea = null;
        let allUsers = [];
        let allProjects = [];
        let areas = [];
        let modulePermissions = {};
        let financialCards = [];
        let availableCash = 0;
        let allTransactions = [];
        let currentProject = null;
        let projectTransactions = [];
        let transactionCategories = {};
        let currentView = 'grid';
        let currentQuickUser = null;

        // Estados de usuarios
        const estados = {
            oficina: { texto: 'Oficina', clase: 'status-oficina', color: '#4CAF50' },
            muestreo: { texto: 'Muestreo', clase: 'status-muestreo', color: '#FF9800' },
            salidaSR: { texto: 'Salida Int.', clase: 'status-salidaSR', color: '#F44336' },
            salidaCR: { texto: 'Salida C/R', clase: 'status-salidaCR', color: '#5C6BC0' },
            descanso: { texto: 'Descanso', clase: 'status-descanso', color: '#9C27B0' },
            vacaciones: { texto: 'Vacaciones', clase: 'status-vacaciones', color: '#009688' },
            vacacionesTxt: { texto: 'Permiso TxT', clase: 'status-vacacionesTxt', color: '#795548' },
            salida: { texto: 'Salida', clase: 'status-salida', color: '#607D8B' }
        };

        // M칩dulos del sistema
        const modulosSistema = {
            'dashboard': { nombre: 'Dashboard', icono: '游늵' },
            'personal': { nombre: 'Control de Personal', icono: '游논' },
            'usuarios': { nombre: 'Gesti칩n de Usuarios', icono: '游녻' },
            'movimientos': { nombre: 'Movimientos', icono: '游댃' },
            'proyectos': { nombre: 'Gesti칩n de Proyectos', icono: '游늶' },
            'project-detail': { nombre: 'Detalle del Proyecto', icono: '游늶' },
            'finanzas': { nombre: 'Control Financiero', icono: '游눯' },
            'areas': { nombre: 'Gesti칩n de 츼reas', icono: '游끽' },
            'configuracion': { nombre: 'Configuraci칩n General', icono: '丘뙖잺' },
            'configuracion-modulos': { nombre: 'Permisos de M칩dulos', icono: '游' },
            'menu-general': { nombre: 'Men칰 General', icono: '游듺勇' },
            'mi-panel': { nombre: 'Mi Panel', icono: '游녻' },
            'mi-configuracion': { nombre: 'Mi Configuraci칩n', icono: '丘뙖잺' },
            'vista-cartas': { nombre: 'Vista de Cartas', icono: '游' }
        };

        // Inicializar la aplicaci칩n
        function init() {
            // Configurar event listeners
            setupEventListeners();

            // Inicializar 치reas
            inicializarAreas();

            // Inicializar categor칤as de transacciones
            inicializarCategoriasTransacciones();

            // Cargar configuraciones de m칩dulos
            cargarConfiguracionModulos();

            // Verificar si hay una sesi칩n activa
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Usuario autenticado
                    currentUser = user;
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';

                    // Obtener informaci칩n del usuario desde Firestore
                    obtenerInformacionUsuario(user.uid);
                } else {
                    // No hay usuario autenticado
                    document.getElementById('app').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                }
            });
        }

        // Inicializar categor칤as de transacciones
        function inicializarCategoriasTransacciones() {
            const categoriasRef = db.collection("configuracion").doc("categorias_transacciones");

            const categoriasPredefinidas = {
                gastos: {
                    'viaticos': { nombre: 'Vi치ticos por Persona', color: '#FF6B6B' },
                    'combustible': { nombre: 'Carga de Combustible', color: '#4ECDC4' },
                    'hospedaje': { nombre: 'Hospedaje', color: '#45B7D1' },
                    'hielos_aguas': { nombre: 'Hielos y Aguas', color: '#96CEB4' },
                    'paqueteria': { nombre: 'Paqueter칤a', color: '#FFEAA7' },
                    'retiro_efectivo': { nombre: 'Retiro de Efectivo', color: '#DDA0DD' },
                    'otros_gastos': { nombre: 'Otros Gastos', color: '#98D8C8' }
                },
                ingresos: {
                    'anticipo': { nombre: 'Anticipo', color: '#A8E6CF' },
                    'abono': { nombre: 'Abono', color: '#DCEDC1' },
                    'liquidacion': { nombre: 'Liquidaci칩n', color: '#FFD3B6' },
                    'otros_ingresos': { nombre: 'Otros Ingresos', color: '#FFAAA5' }
                }
            };

            categoriasRef.get().then(doc => {
                if (!doc.exists) {
                    categoriasRef.set(categoriasPredefinidas);
                    transactionCategories = categoriasPredefinidas;
                } else {
                    transactionCategories = doc.data();
                }
            }).catch(error => {
                console.error("Error al inicializar categor칤as:", error);
                transactionCategories = categoriasPredefinidas;
            });
        }

        // Cargar categor칤as para selectores
        function cargarCategoriasParaSelectores(tipo) {
            const categorySelect = document.getElementById('transactionCategory');
            categorySelect.innerHTML = '<option value="">Seleccione una categor칤a</option>';

            const categorias = tipo === 'gasto' ? transactionCategories.gastos : transactionCategories.ingresos;

            if (categorias) {
                Object.keys(categorias).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = categorias[key].nombre;
                    categorySelect.appendChild(option);
                });
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Logout
            document.getElementById('btnLogout').addEventListener('click', handleLogout);

            // Sidebar toggle
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);

            // Menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const module = this.getAttribute('data-module');

                    // Verificar permisos antes de cambiar de m칩dulo
                    if (tienePermisoModulo(module)) {
                        switchModule(module);
                    } else {
                        alert('No tiene permisos para acceder a este m칩dulo');
                    }
                });
            });

            // User modal form
            document.getElementById('userForm').addEventListener('submit', saveUser);

            // Project modal form
            document.getElementById('projectForm').addEventListener('submit', saveProject);

            // Area modal form
            document.getElementById('areaForm').addEventListener('submit', saveArea);

            // Card modal form
            document.getElementById('cardForm').addEventListener('submit', saveCard);

            // Add funds form
            document.getElementById('addFundsForm').addEventListener('submit', function (e) {
                e.preventDefault();
                addFundsToCard();
            });

            // Withdraw form
            document.getElementById('withdrawForm').addEventListener('submit', function (e) {
                e.preventDefault();
                withdrawFromCard();
            });

            // Transaction form
            document.getElementById('transactionForm').addEventListener('submit', saveTransaction);
            document.getElementById('transactionType').addEventListener('change', toggleTransactionFields);
            document.getElementById('transactionPaymentMethod').addEventListener('change', toggleCardSelection);

            // Filtros
            document.getElementById('dashboardAreaFilter').addEventListener('change', loadDashboardData);
            document.getElementById('personalAreaFilter').addEventListener('change', cargarUsuarios);
            document.getElementById('personalStatusFilter').addEventListener('change', cargarUsuarios);
            document.getElementById('usuariosAreaFilter').addEventListener('change', cargarUsuariosParaEdicion);
            document.getElementById('usuariosRoleFilter').addEventListener('change', cargarUsuariosParaEdicion);
            document.getElementById('proyectosStatusFilter').addEventListener('change', loadProjects);
        }

        // Manejar login
        function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    document.getElementById('loginError').textContent = error.message;
                });
        }

        // Manejar logout
        function handleLogout() {
            auth.signOut();
        }

        // Alternar sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        // Cambiar m칩dulo
        function switchModule(module) {
            // Verificar permisos
            if (!tienePermisoModulo(module)) {
                alert('No tiene permisos para acceder a este m칩dulo');
                return;
            }

            // Actualizar men칰 activo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            const menuItem = document.querySelector(`[data-module="${module}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
            }

            // Actualizar t칤tulo del m칩dulo
            const moduleTitle = modulosSistema[module]?.nombre || 'M칩dulo';
            document.getElementById('moduleTitle').textContent = moduleTitle;

            // Ocultar todos los m칩dulos
            document.querySelectorAll('.module').forEach(mod => {
                mod.classList.remove('active');
            });

            // Mostrar m칩dulo seleccionado
            const moduleElement = document.getElementById(`${module}-module`);
            if (moduleElement) {
                moduleElement.classList.add('active');
            }

            // Cargar datos espec칤ficos del m칩dulo
            switch (module) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'personal':
                    cargarUsuarios();
                    break;
                case 'usuarios':
                    cargarUsuariosParaEdicion();
                    break;
                case 'movimientos':
                    cargarMovimientos();
                    break;
                case 'proyectos':
                    loadProjects();
                    break;
                case 'finanzas':
                    loadFinancialData();
                    break;
                case 'areas':
                    cargarAreas();
                    break;
                case 'configuracion':
                    cargarConfiguracionSistema();
                    break;
                case 'configuracion-modulos':
                    cargarConfiguracionModulosUI();
                    break;
                case 'mi-panel':
                    loadMyPanel();
                    break;
                case 'mi-configuracion':
                    loadMyConfiguration();
                    break;
                case 'vista-cartas':
                    loadUsersCards();
                    // Cargar filtros de 치rea
                    cargarAreasParaSelectores().then(() => {
                        actualizarSelectoresArea();
                    });
                    break;
            }
        }
        // Inicializar vista de cartas cuando se carga el m칩dulo
        document.addEventListener('DOMContentLoaded', function () {
            // Agregar estilos para notificaciones
            const style = document.createElement('style');
            style.textContent = `
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
        }
    `;
            document.head.appendChild(style);
        });
        // Funci칩n para cargar el panel personal
        function loadMyPanel() {
            if (!currentUser) return;

            // Cargar informaci칩n del usuario actual
            db.collection("usuarios").doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();

                        // Actualizar estado actual
                        const estadoInfo = estados[userData.estado] || estados.muestreo;
                        document.getElementById('myCurrentStatus').innerHTML =
                            `<span class="status ${estadoInfo.clase}">${estadoInfo.texto}</span>`;

                        // Actualizar 칰ltima actualizaci칩n
                        if (userData.ultimaActualizacion) {
                            const fecha = userData.ultimaActualizacion.toDate();
                            document.getElementById('myLastUpdate').textContent =
                                `칔ltima actualizaci칩n: ${fecha.toLocaleString()}`;
                        }

                        // Actualizar ubicaci칩n
                        document.getElementById('myLocation').textContent =
                            userData.ubicacion || 'No disponible';

                        // Generar botones de estado
                        generateStatusButtons(userData.estado);
                    }
                })
                .catch(error => {
                    console.error("Error al cargar informaci칩n del usuario:", error);
                });

            // Cargar proyectos asignados
            loadMyProjects();
        }

        // Funci칩n para generar botones de estado
        function generateStatusButtons(currentStatus) {
            const container = document.getElementById('statusButtons');
            container.innerHTML = '';

            Object.keys(estados).forEach(key => {
                const estado = estados[key];
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `status-button ${currentStatus === key ? 'active' : ''}`;
                button.style.backgroundColor = estado.color;
                button.innerHTML = `${estado.texto}`;
                button.onclick = () => changeMyStatus(key);

                container.appendChild(button);
            });
        }

        // Funci칩n para cambiar el estado personal
        function changeMyStatus(nuevoEstado) {
            if (!currentUser) return;

            // Obtener ubicaci칩n actual
            obtenerUbicacion().then(ubicacion => {
                // Actualizar estado en Firestore
                db.collection("usuarios").doc(currentUser.uid).update({
                    estado: nuevoEstado,
                    ultimaActualizacion: new Date(),
                    ubicacion: ubicacion
                })
                    .then(() => {
                        // Obtener estado anterior para registrar movimiento
                        db.collection("usuarios").doc(currentUser.uid).get()
                            .then(doc => {
                                const estadoAnterior = doc.data().estado;

                                // Registrar movimiento
                                registrarMovimiento(
                                    currentUser.uid,
                                    estadoAnterior,
                                    nuevoEstado,
                                    "Cambio autom치tico",
                                    currentUser.uid
                                );

                                // Recargar panel
                                loadMyPanel();

                                // Mostrar confirmaci칩n
                                alert(`Estado cambiado a: ${estados[nuevoEstado].texto}`);
                            });
                    })
                    .catch(error => {
                        console.error("Error al cambiar estado:", error);
                        alert("Error al cambiar estado: " + error.message);
                    });
            }).catch(error => {
                console.error("Error al obtener ubicaci칩n:", error);
                // Actualizar sin ubicaci칩n
                db.collection("usuarios").doc(currentUser.uid).update({
                    estado: nuevoEstado,
                    ultimaActualizacion: new Date()
                })
                    .then(() => {
                        loadMyPanel();
                        alert(`Estado cambiado a: ${estados[nuevoEstado].texto}`);
                    });
            });
        }

        // Funci칩n para cargar proyectos asignados
        function loadMyProjects() {
            const tableBody = document.getElementById('my-projects-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Cargando proyectos...</td></tr>';

            // Buscar proyectos donde el usuario es l칤der o participante
            db.collection("proyectos")
                .where("estado", "==", "active")
                .get()
                .then(querySnapshot => {
                    tableBody.innerHTML = '';
                    let myProjectsCount = 0;

                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="6">No tienes proyectos asignados</td></tr>';
                        document.getElementById('myProjectsCount').textContent = '0';
                        return;
                    }

                    // Obtener informaci칩n de l칤deres
                    const leadersPromise = db.collection("usuarios").get();

                    Promise.all([querySnapshot, leadersPromise]).then(([projectsSnapshot, usersSnapshot]) => {
                        const usersMap = new Map();
                        usersSnapshot.forEach(doc => {
                            usersMap.set(doc.id, doc.data());
                        });

                        projectsSnapshot.forEach(doc => {
                            const proyecto = doc.data();

                            // Verificar si el usuario actual est치 asignado al proyecto
                            const isAssigned = proyecto.lider === currentUser.uid ||
                                (proyecto.participantes && proyecto.participantes.includes(currentUser.uid));

                            if (isAssigned) {
                                myProjectsCount++;

                                const leaderInfo = usersMap.get(proyecto.lider) || { nombre: "Desconocido", apellidoPaterno: "" };
                                const leaderName = `${leaderInfo.nombre || ''} ${leaderInfo.apellidoPaterno || ''}`.trim();

                                const fila = document.createElement('tr');
                                fila.innerHTML = `
                            <td>${proyecto.nombre || 'N/A'}</td>
                            <td>${leaderName || 'N/A'}</td>
                            <td><span class="project-status status-active">Activo</span></td>
                            <td>${proyecto.fechaInicio ? proyecto.fechaInicio.toDate().toLocaleDateString() : 'N/A'}</td>
                            <td>${proyecto.fechaFin ? proyecto.fechaFin.toDate().toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewMyProject('${doc.id}')">Ver</button>
                            </td>
                        `;

                                tableBody.appendChild(fila);
                            }
                        });

                        document.getElementById('myProjectsCount').textContent = myProjectsCount.toString();

                        if (myProjectsCount === 0) {
                            tableBody.innerHTML = '<tr><td colspan="6">No tienes proyectos asignados</td></tr>';
                        }
                    });
                })
                .catch(error => {
                    console.error("Error al cargar proyectos:", error);
                    tableBody.innerHTML = '<tr><td colspan="6">Error al cargar los proyectos</td></tr>';
                });
        }

        // Funci칩n para ver proyecto desde mi panel
        function viewMyProject(projectId) {
            // Usar la funci칩n existente viewProject
            viewProject(projectId);
        }

        // Funci칩n para cargar configuraci칩n personal
        function loadMyConfiguration() {
            if (!currentUser) return;

            // Cargar informaci칩n del perfil
            db.collection("usuarios").doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();

                        document.getElementById('myProfileName').value = userData.nombre || '';
                        document.getElementById('myProfileLastName').value = userData.apellidoPaterno || '';
                        document.getElementById('myProfileMotherLastName').value = userData.apellidoMaterno || '';
                        document.getElementById('myProfileEmail').value = userData.email || '';
                        document.getElementById('myProfileArea').value = userData.area || 'No asignada';
                    }
                })
                .catch(error => {
                    console.error("Error al cargar perfil:", error);
                });

            // Cargar preferencias
            loadMyPreferences();
        }

        // Funci칩n para cargar preferencias personales
        function loadMyPreferences() {
            db.collection("preferencias_usuarios").doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const prefs = doc.data();
                        document.getElementById('myNotifications').checked = prefs.notificaciones !== false;
                        document.getElementById('myLanguage').value = prefs.idioma || 'es';
                    }
                })
                .catch(error => {
                    console.error("Error al cargar preferencias:", error);
                });
        }

        // Funci칩n para guardar perfil personal
        document.getElementById('myProfileForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const nombre = document.getElementById('myProfileName').value;
            const apellidoPaterno = document.getElementById('myProfileLastName').value;
            const apellidoMaterno = document.getElementById('myProfileMotherLastName').value;

            if (!nombre || !apellidoPaterno) {
                alert('Por favor complete los campos requeridos');
                return;
            }

            db.collection("usuarios").doc(currentUser.uid).update({
                nombre: nombre,
                apellidoPaterno: apellidoPaterno,
                apellidoMaterno: apellidoMaterno,
                fechaActualizacion: new Date()
            })
                .then(() => {
                    alert('Perfil actualizado correctamente');
                })
                .catch(error => {
                    alert('Error al actualizar perfil: ' + error.message);
                });
        });

        // Funci칩n para cambiar contrase침a
        document.getElementById('myPasswordForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const currentPassword = document.getElementById('myCurrentPassword').value;
            const newPassword = document.getElementById('myNewPassword').value;
            const confirmPassword = document.getElementById('myConfirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('Las contrase침as nuevas no coinciden');
                return;
            }

            if (newPassword.length < 6) {
                alert('La contrase침a debe tener al menos 6 caracteres');
                return;
            }

            // Reautenticar al usuario
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email,
                currentPassword
            );

            currentUser.reauthenticateWithCredential(credential)
                .then(() => {
                    // Cambiar contrase침a
                    return currentUser.updatePassword(newPassword);
                })
                .then(() => {
                    alert('Contrase침a cambiada correctamente');
                    document.getElementById('myPasswordForm').reset();
                })
                .catch(error => {
                    alert('Error al cambiar contrase침a: ' + error.message);
                });
        });

        // Funci칩n para guardar preferencias
        function saveMyPreferences() {
            const notificaciones = document.getElementById('myNotifications').checked;
            const idioma = document.getElementById('myLanguage').value;

            db.collection("preferencias_usuarios").doc(currentUser.uid).set({
                notificaciones: notificaciones,
                idioma: idioma,
                fechaActualizacion: new Date()
            })
                .then(() => {
                    alert('Preferencias guardadas correctamente');
                })
                .catch(error => {
                    alert('Error al guardar preferencias: ' + error.message);
                });
        }

        // Cargar configuraci칩n de m칩dulos
        function cargarConfiguracionModulos() {
            db.collection("configuracion").doc("modulos").get()
                .then(doc => {
                    if (doc.exists) {
                        modulePermissions = doc.data();
                    } else {
                        // Configuraci칩n por defecto
                        modulePermissions = {
                            dashboard: { roles: ['administrador', 'usuario'], areas: ['todos'] },
                            personal: { roles: ['administrador', 'usuario'], areas: ['todos'] },
                            usuarios: { roles: ['administrador'], areas: ['todos'] },
                            movimientos: { roles: ['administrador', 'usuario'], areas: ['todos'] },
                            proyectos: { roles: ['administrador', 'usuario'], areas: ['todos'] },
                            'project-detail': { roles: ['administrador', 'usuario'], areas: ['todos'] },
                            finanzas: { roles: ['administrador'], areas: ['todos'] },
                            areas: { roles: ['administrador'], areas: ['todos'] },
                            configuracion: { roles: ['administrador'], areas: ['todos'] },
                            'configuracion-modulos': { roles: ['administrador'], areas: ['todos'] },
                            'menu-general': { roles: ['administrador', 'usuario'], areas: ['todos'] },
                            'mi-panel': { roles: ['administrador', 'usuario'], areas: ['todos'] },
                            'mi-configuracion': { roles: ['administrador', 'usuario'], areas: ['todos'] },
                            'vista-cartas': { roles: ['administrador', 'usuario'], areas: ['todos'] }
                        };

                        // Guardar configuraci칩n por defecto
                        db.collection("configuracion").doc("modulos").set(modulePermissions);
                    }
                })
                .catch(error => {
                    console.error("Error al cargar configuraci칩n de m칩dulos:", error);
                });
        }

        // Verificar permisos de m칩dulo
        function tienePermisoModulo(moduleName) {
            if (!modulePermissions[moduleName]) return true; // Si no hay configuraci칩n, permitir acceso

            const moduleConfig = modulePermissions[moduleName];

            // Verificar rol
            if (!moduleConfig.roles.includes(currentUserRole) && !moduleConfig.roles.includes('todos')) {
                return false;
            }

            // Verificar 치rea
            if (!moduleConfig.areas.includes(currentUserArea) && !moduleConfig.areas.includes('todos')) {
                return false;
            }

            return true;
        }

        // Actualizar visibilidad de m칩dulos en el men칰
        function actualizarVisibilidadModulos() {
            document.querySelectorAll('.menu-item').forEach(item => {
                const module = item.getAttribute('data-module');
                if (module && !tienePermisoModulo(module)) {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'flex';
                }
            });
        }

        // Cargar configuraci칩n del sistema
        function cargarConfiguracionSistema() {
            db.collection("configuracion").doc("sistema").get()
                .then(doc => {
                    if (doc.exists) {
                        const config = doc.data();
                        document.getElementById('systemName').value = config.nombreSistema || 'Sistema de Control de Personal';
                        document.getElementById('systemEmail').value = config.emailSistema || 'sistema@empresa.com';
                        document.getElementById('reportPeriod').value = config.periodoReporte || 'semanal';
                    }
                })
                .catch(error => {
                    console.error("Error al cargar configuraci칩n del sistema:", error);
                });
        }

        // Guardar configuraci칩n del sistema
        function guardarConfiguracionSistema() {
            const configData = {
                nombreSistema: document.getElementById('systemName').value,
                emailSistema: document.getElementById('systemEmail').value,
                periodoReporte: document.getElementById('reportPeriod').value,
                fechaActualizacion: new Date()
            };

            db.collection("configuracion").doc("sistema").set(configData)
                .then(() => {
                    alert('Configuraci칩n guardada correctamente');
                })
                .catch(error => {
                    alert('Error al guardar configuraci칩n: ' + error.message);
                });
        }

        // Cargar configuraci칩n de m칩dulos en la UI
        function cargarConfiguracionModulosUI() {
            const grid = document.getElementById('modulesPermissionsGrid');
            grid.innerHTML = '';

            // Obtener todas las 치reas para los checkboxes
            cargarAreasParaConfiguracion().then(() => {
                Object.keys(modulosSistema).forEach(moduleKey => {
                    const modulo = modulosSistema[moduleKey];
                    const config = modulePermissions[moduleKey] || { roles: [], areas: [] };

                    const permissionItem = document.createElement('div');
                    permissionItem.className = 'permission-item';
                    permissionItem.innerHTML = `
                    <h4>${modulo.icono} ${modulo.nombre}</h4>
                    <div class="checkbox-group">
                        <h5>Roles Permitidos:</h5>
                        <div class="checkbox-item">
                            <input type="checkbox" id="role-admin-${moduleKey}" value="administrador" ${config.roles.includes('administrador') ? 'checked' : ''}>
                            <label for="role-admin-${moduleKey}">Administrador</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="role-user-${moduleKey}" value="usuario" ${config.roles.includes('usuario') ? 'checked' : ''}>
                            <label for="role-user-${moduleKey}">Usuario</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="role-all-${moduleKey}" value="todos" ${config.roles.includes('todos') ? 'checked' : ''}>
                            <label for="role-all-${moduleKey}">Todos los roles</label>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <h5>츼reas Permitidas:</h5>
                        <div class="checkbox-item">
                            <input type="checkbox" id="area-all-${moduleKey}" value="todos" ${config.areas.includes('todos') ? 'checked' : ''}>
                            <label for="area-all-${moduleKey}">Todas las 치reas</label>
                        </div>
                        ${areas.map(area => `
                            <div class="checkbox-item">
                                <input type="checkbox" id="area-${area.id}-${moduleKey}" value="${area.id}" ${config.areas.includes(area.id) ? 'checked' : ''}>
                                <label for="area-${area.id}-${moduleKey}">${area.nombre}</label>
                            </div>
                        `).join('')}
                    </div>
                `;

                    grid.appendChild(permissionItem);
                });
            });
        }

        // Cargar 치reas para configuraci칩n
        function cargarAreasParaConfiguracion() {
            return db.collection("areas").get().then(querySnapshot => {
                areas = [];
                querySnapshot.forEach(doc => {
                    areas.push({ id: doc.id, ...doc.data() });
                });
            });
        }

        // Guardar configuraci칩n de m칩dulos
        function guardarConfiguracionModulos() {
            const nuevosPermisos = {};

            Object.keys(modulosSistema).forEach(moduleKey => {
                const roles = [];
                const areasPermitidas = [];

                // Obtener roles seleccionados
                if (document.getElementById(`role-all-${moduleKey}`).checked) {
                    roles.push('todos');
                } else {
                    if (document.getElementById(`role-admin-${moduleKey}`).checked) {
                        roles.push('administrador');
                    }
                    if (document.getElementById(`role-user-${moduleKey}`).checked) {
                        roles.push('usuario');
                    }
                }

                // Obtener 치reas seleccionadas
                if (document.getElementById(`area-all-${moduleKey}`).checked) {
                    areasPermitidas.push('todos');
                } else {
                    areas.forEach(area => {
                        if (document.getElementById(`area-${area.id}-${moduleKey}`).checked) {
                            areasPermitidas.push(area.id);
                        }
                    });
                }

                nuevosPermisos[moduleKey] = {
                    roles: roles,
                    areas: areasPermitidas
                };
            });

            // Guardar en Firebase
            db.collection("configuracion").doc("modulos").set(nuevosPermisos)
                .then(() => {
                    modulePermissions = nuevosPermisos;
                    alert('Configuraci칩n de m칩dulos guardada correctamente');
                    actualizarVisibilidadModulos();
                })
                .catch(error => {
                    alert('Error al guardar configuraci칩n: ' + error.message);
                });
        }

        // Obtener informaci칩n del usuario desde Firestore
        function obtenerInformacionUsuario(userId) {
            db.collection("usuarios").doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        currentUserRole = userData.rol || 'usuario';
                        currentUserArea = userData.area || null;

                        // Actualizar UI con el rol
                        const userRoleBadge = document.getElementById('userRoleBadge');
                        userRoleBadge.textContent = currentUserRole === 'administrador' ? 'Administrador' : 'Usuario';
                        userRoleBadge.className = `user-role ${currentUserRole === 'administrador' ? 'role-admin' : 'role-user'}`;

                        // Actualizar UI con el 치rea si existe
                        const userAreaBadge = document.getElementById('userAreaBadge');
                        if (currentUserArea) {
                            userAreaBadge.textContent = userData.areaNombre || currentUserArea;
                            userAreaBadge.className = `area-badge area-${currentUserArea}`;
                            userAreaBadge.style.display = 'inline-block';
                        } else {
                            userAreaBadge.style.display = 'none';
                        }

                        // Actualizar visibilidad de m칩dulos
                        actualizarVisibilidadModulos();

                        // Cargar datos iniciales
                        loadDashboardData();
                        cargarAreasParaSelectores();
                    } else {
                        // Si el usuario no existe en Firestore, crear registro por defecto
                        registrarUsuarioEnSistema(currentUser);
                    }
                })
                .catch(error => {
                    console.error("Error al obtener informaci칩n del usuario:", error);
                });
        }

        // Registrar usuario en el sistema
        function registrarUsuarioEnSistema(user, userRole = 'usuario', userArea = null) {
            db.collection("usuarios").doc(user.uid).get()
                .then(doc => {
                    if (!doc.exists) {
                        const userData = {
                            nombre: user.displayName || "Usuario",
                            email: user.email,
                            estado: "oficina",
                            rol: userRole,
                            area: userArea,
                            ultimaActualizacion: new Date(),
                            userId: user.uid
                        };

                        db.collection("usuarios").doc(user.uid).set(userData)
                            .then(() => {
                                console.log("Usuario registrado en el sistema");
                                obtenerInformacionUsuario(user.uid);
                            })
                            .catch(error => {
                                console.error("Error al registrar usuario:", error);
                            });
                    }
                })
                .catch(error => {
                    console.error("Error al verificar usuario:", error);
                });
        }

        // Inicializar 치reas en el sistema
        function inicializarAreas() {
            // Verificar si ya existen las 치reas en Firestore
            const areasRef = db.collection("areas");

            // Crear 치reas predefinidas si no existen
            const areasPredefinidas = {
                muestreo: { nombre: 'Muestreo', color: '#FF9800' },
                rrhh: { nombre: 'RRHH', color: '#9C27B0' },
                administracion: { nombre: 'Administraci칩n', color: '#2196F3' },
                direccion: { nombre: 'Direcci칩n', color: '#F44336' }
            };

            Object.keys(areasPredefinidas).forEach(key => {
                areasRef.doc(key).get().then(doc => {
                    if (!doc.exists) {
                        areasRef.doc(key).set({
                            nombre: areasPredefinidas[key].nombre,
                            color: areasPredefinidas[key].color,
                            fechaCreacion: new Date()
                        });
                    }
                });
            });

            // Cargar 치reas para los selectores
            cargarAreasParaSelectores();
        }

        // Cargar 치reas en los selectores
        function cargarAreasParaSelectores() {
            db.collection("areas").get().then(querySnapshot => {
                areas = [];
                querySnapshot.forEach(doc => {
                    areas.push({ id: doc.id, ...doc.data() });
                });

                // Actualizar selectores de 치rea
                actualizarSelectoresArea();
            });
        }

        // Actualizar todos los selectores de 치rea en la interfaz
        function actualizarSelectoresArea() {
            const areaSelectors = [
                'dashboardAreaFilter',
                'personalAreaFilter',
                'usuariosAreaFilter',
                'userArea',
                'projectLeader'
            ];

            areaSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    // Guardar valor seleccionado actual
                    const currentValue = selector.value;

                    // Limpiar opciones (excepto la primera si es un filtro)
                    if (selectorId.includes('Filter')) {
                        selector.innerHTML = '<option value="todos">Todas las 치reas</option>';
                    } else {
                        selector.innerHTML = '<option value="">Seleccione un 치rea</option>';
                    }

                    // Agregar 치reas
                    areas.forEach(area => {
                        const option = document.createElement('option');
                        option.value = area.id;
                        option.textContent = area.nombre;
                        selector.appendChild(option);
                    });

                    // Restaurar valor seleccionado si existe
                    if (currentValue && selector.querySelector(`option[value="${currentValue}"]`)) {
                        selector.value = currentValue;
                    }
                }
            });
        }

        // Cargar datos del dashboard
        function loadDashboardData() {
            // Cargar estad칤sticas
            db.collection("usuarios").get().then(querySnapshot => {
                const totalUsers = querySnapshot.size;
                let usersInOffice = 0;
                let usersSampling = 0;

                querySnapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.estado === 'oficina') usersInOffice++;
                    if (user.estado === 'muestreo') usersSampling++;
                });

                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('usersInOffice').textContent = usersInOffice;
                document.getElementById('usersSampling').textContent = usersSampling;

                // Actualizar tabla del dashboard
                updateDashboardTable(querySnapshot);
            });

            // Cargar proyectos activos
            db.collection("proyectos").where("estado", "==", "active").get().then(querySnapshot => {
                document.getElementById('activeProjects').textContent = querySnapshot.size;
            });
        }

        // Actualizar tabla del dashboard
        function updateDashboardTable(querySnapshot) {
            const tableBody = document.getElementById('dashboard-table-body');
            tableBody.innerHTML = '';

            if (querySnapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No hay usuarios registrados</td></tr>';
                return;
            }

            const areaFilter = document.getElementById('dashboardAreaFilter').value;

            querySnapshot.forEach((doc) => {
                const usuario = doc.data();

                // Aplicar filtro de 치rea
                if (areaFilter !== 'todos' && usuario.area !== areaFilter) {
                    return;
                }

                const fecha = usuario.ultimaActualizacion ? usuario.ultimaActualizacion.toDate() : new Date();
                const nombreCompleto = `${usuario.nombre || ''} ${usuario.apellidoPaterno || ''} ${usuario.apellidoMaterno || ''}`.trim();

                const fila = document.createElement('tr');
                fila.innerHTML = `
                <td>${nombreCompleto || 'N/A'}</td>
                <td>${usuario.email || 'N/A'}</td>
                <td>${usuario.area || 'No asignada'}</td>
                <td><span class="status ${estados[usuario.estado]?.clase || 'status-muestreo'}">${estados[usuario.estado]?.texto || 'Muestreo'}</span></td>
                <td>${fecha.toLocaleString()}</td>
            `;

                tableBody.appendChild(fila);
            });

            if (tableBody.children.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No hay usuarios con los filtros seleccionados</td></tr>';
            }
        }

        // Cargar usuarios para el m칩dulo de personal
        function cargarUsuarios() {
            const tableBody = document.getElementById('personal-table-body');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Cargando datos...</td></tr>';

            let query = db.collection("usuarios").where("nombre", "!=", "Usuario").orderBy("nombre");

            const areaSeleccionada = document.getElementById('personalAreaFilter').value;
            const statusSeleccionado = document.getElementById('personalStatusFilter').value;

            if (areaSeleccionada !== 'todos') {
                query = query.where("area", "==", areaSeleccionada);
            }

            query.get()
                .then((querySnapshot) => {
                    tableBody.innerHTML = '';
                    allUsers = [];

                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="7">No hay usuarios registrados</td></tr>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const usuario = doc.data();

                        // Aplicar filtro de estado
                        if (statusSeleccionado !== 'todos' && usuario.estado !== statusSeleccionado) {
                            return;
                        }

                        usuario.id = doc.id;
                        allUsers.push(usuario);

                        const fecha = usuario.ultimaActualizacion ? usuario.ultimaActualizacion.toDate() : new Date();
                        const nombreCompleto = `${usuario.nombre || ''} ${usuario.apellidoPaterno || ''} ${usuario.apellidoMaterno || ''}`.trim();

                        const fila = document.createElement('tr');
                        fila.innerHTML = `
                        <td>${nombreCompleto || 'N/A'}</td>
                        <td>${usuario.email || 'N/A'}</td>
                        <td>${usuario.area || 'No asignada'}</td>
                        <td><span class="status ${estados[usuario.estado]?.clase || 'status-muestreo'}">${estados[usuario.estado]?.texto || 'Muestreo'}</span></td>
                        <td>${fecha.toLocaleString()}</td>
                        <td>${usuario.ubicacion || 'No registrada'}</td>
                        <td>
                            <select class="change-status" data-userid="${doc.id}">
                                <option value="">Cambiar estado</option>
                                <option value="oficina">Oficina</option>
                                <option value="muestreo">Muestreo</option>
                                <option value="salidaSR">Salida Intermitente</option>
                                <option value="salidaCR">Salida con regreso</option>
                                <option value="descanso">Descanso</option>
                                <option value="vacaciones">Vacaciones</option>
                                <option value="vacacionesTxt">Permiso TxT</option>
                                <option value="salida">Salida</option>
                            </select>
                        </td>
                    `;

                        tableBody.appendChild(fila);
                    });

                    // Agregar event listeners para cambiar estado
                    document.querySelectorAll('.change-status').forEach(select => {
                        select.addEventListener('change', function () {
                            const nuevoEstado = this.value;
                            const userId = this.getAttribute('data-userid');

                            if (nuevoEstado) {
                                cambiarEstadoUsuario(userId, nuevoEstado);
                                this.value = "";
                            }
                        });
                    });

                    if (tableBody.children.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7">No hay usuarios con los filtros seleccionados</td></tr>';
                    }
                })
                .catch((error) => {
                    console.error("Error al cargar usuarios: ", error);
                    tableBody.innerHTML = '<tr><td colspan="7">Error al cargar los datos</td></tr>';
                });
        }

        // Cambiar estado de un usuario
        function cambiarEstadoUsuario(userId, nuevoEstado) {
            db.collection("usuarios").doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const usuario = doc.data();
                        const estadoAnterior = usuario.estado;

                        // Obtener ubicaci칩n
                        obtenerUbicacion().then(ubicacion => {
                            db.collection("usuarios").doc(userId).update({
                                estado: nuevoEstado,
                                ultimaActualizacion: new Date(),
                                ubicacion: ubicacion
                            })
                                .then(() => {
                                    // Registrar movimiento
                                    registrarMovimiento(userId, estadoAnterior, nuevoEstado, "Cambio manual", currentUser.uid);

                                    // Recargar datos
                                    if (document.getElementById('dashboard-module').classList.contains('active')) {
                                        loadDashboardData();
                                    }
                                    if (document.getElementById('personal-module').classList.contains('active')) {
                                        cargarUsuarios();
                                    }
                                    if (document.getElementById('usuarios-module').classList.contains('active')) {
                                        cargarUsuariosParaEdicion();
                                    }
                                })
                                .catch(error => {
                                    console.error("Error al cambiar estado:", error);
                                    alert("Error al cambiar estado: " + error.message);
                                });
                        }).catch(error => {
                            console.error("Error al obtener ubicaci칩n:", error);
                            // Actualizar sin ubicaci칩n
                            db.collection("usuarios").doc(userId).update({
                                estado: nuevoEstado,
                                ultimaActualizacion: new Date()
                            })
                                .then(() => {
                                    registrarMovimiento(userId, estadoAnterior, nuevoEstado, "Cambio manual", currentUser.uid);

                                    // Recargar datos
                                    if (document.getElementById('dashboard-module').classList.contains('active')) {
                                        loadDashboardData();
                                    }
                                    if (document.getElementById('personal-module').classList.contains('active')) {
                                        cargarUsuarios();
                                    }
                                    if (document.getElementById('usuarios-module').classList.contains('active')) {
                                        cargarUsuariosParaEdicion();
                                    }
                                });
                        });
                    }
                })
                .catch(error => {
                    console.error("Error al obtener usuario:", error);
                });
        }

        // Obtener ubicaci칩n
        function obtenerUbicacion() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject("La geolocalizaci칩n no es compatible con este navegador");
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const { latitude, longitude } = position.coords;
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`);
                            const data = await response.json();

                            if (data && data.address) {
                                const address = data.address;
                                let locationName = "";

                                if (address.city) {
                                    locationName = address.city;
                                } else if (address.town) {
                                    locationName = address.town;
                                } else if (address.village) {
                                    locationName = address.village;
                                } else if (address.municipality) {
                                    locationName = address.municipality;
                                }

                                if (address.state) {
                                    locationName += locationName ? `, ${address.state}` : address.state;
                                }

                                if (address.country) {
                                    locationName += locationName ? `, ${address.country}` : address.country;
                                }

                                resolve(locationName || "Ubicaci칩n no disponible");
                            } else {
                                resolve("Ubicaci칩n no disponible");
                            }
                        } catch (error) {
                            console.error("Error al obtener ubicaci칩n:", error);
                            resolve("Ubicaci칩n no disponible");
                        }
                    },
                    (error) => {
                        console.error("Error de geolocalizaci칩n:", error);
                        resolve("Ubicaci칩n no disponible");
                    }
                );
            });
        }

        // Registrar movimiento
        function registrarMovimiento(userId, estadoAnterior, estadoNuevo, motivo, responsableId) {
            obtenerUbicacion().then(ubicacion => {
                db.collection("movimientos").add({
                    userId: userId,
                    estadoAnterior: estadoAnterior,
                    estadoNuevo: estadoNuevo,
                    fecha: new Date(),
                    motivo: motivo,
                    responsableId: responsableId,
                    ubicacion: ubicacion
                });
            }).catch(error => {
                console.error("Error al obtener ubicaci칩n:", error);
                db.collection("movimientos").add({
                    userId: userId,
                    estadoAnterior: estadoAnterior,
                    estadoNuevo: estadoNuevo,
                    fecha: new Date(),
                    motivo: motivo,
                    responsableId: responsableId,
                    ubicacion: "Ubicaci칩n no disponible"
                });
            });
        }

        // Cargar usuarios para edici칩n
        function cargarUsuariosParaEdicion() {
            const tableBody = document.getElementById('usuarios-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Cargando datos...</td></tr>';

            let query = db.collection("usuarios").where("nombre", "!=", "Usuario").orderBy("nombre");

            const areaSeleccionada = document.getElementById('usuariosAreaFilter').value;
            const roleSeleccionado = document.getElementById('usuariosRoleFilter').value;

            if (areaSeleccionada !== 'todos') {
                query = query.where("area", "==", areaSeleccionada);
            }

            query.get()
                .then((querySnapshot) => {
                    tableBody.innerHTML = '';

                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="6">No hay usuarios registrados</td></tr>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const usuario = doc.data();

                        // Aplicar filtro de rol
                        if (roleSeleccionado !== 'todos' && usuario.rol !== roleSeleccionado) {
                            return;
                        }

                        const nombreCompleto = `${usuario.nombre || ''} ${usuario.apellidoPaterno || ''} ${usuario.apellidoMaterno || ''}`.trim();

                        const fila = document.createElement('tr');
                        fila.innerHTML = `
                        <td>${nombreCompleto || 'N/A'}</td>
                        <td>${usuario.email || 'N/A'}</td>
                        <td>${usuario.area || 'No asignada'}</td>
                        <td>${usuario.rol === 'administrador' ? 'Administrador' : 'Usuario'}</td>
                        <td><span class="status ${estados[usuario.estado]?.clase || 'status-muestreo'}">${estados[usuario.estado]?.texto || 'Muestreo'}</span></td>
                        <td>
                            <button class="btn btn-secondary" onclick="editUser('${doc.id}')">Editar</button>
                            <button class="btn btn-danger" onclick="deleteUser('${doc.id}')">Eliminar</button>
                        </td>
                    `;

                        tableBody.appendChild(fila);
                    });

                    if (tableBody.children.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6">No hay usuarios con los filtros seleccionados</td></tr>';
                    }
                })
                .catch((error) => {
                    console.error("Error al cargar usuarios: ", error);
                    tableBody.innerHTML = '<tr><td colspan="6">Error al cargar los datos</td></tr>';
                });
        }

        // Mostrar modal de usuario
        function showUserModal(userId = null) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');

            form.reset();
            document.getElementById('editUserId').value = '';

            if (userId) {
                title.textContent = 'Editar Usuario';

                // Cargar datos del usuario
                db.collection("usuarios").doc(userId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const usuario = doc.data();
                            document.getElementById('editUserId').value = userId;
                            document.getElementById('userNombre').value = usuario.nombre || '';
                            document.getElementById('userApellidoPaterno').value = usuario.apellidoPaterno || '';
                            document.getElementById('userApellidoMaterno').value = usuario.apellidoMaterno || '';
                            document.getElementById('userEmail').value = usuario.email || '';
                            document.getElementById('userArea').value = usuario.area || '';
                            document.getElementById('userStatus').value = usuario.estado || 'oficina';
                            document.getElementById('userRole').value = usuario.rol || 'usuario';

                            // Ocultar campo de contrase침a para edici칩n
                            document.getElementById('userPassword').closest('.form-group').style.display = 'none';
                        }
                    });
            } else {
                title.textContent = 'Agregar Usuario';
                document.getElementById('userPassword').closest('.form-group').style.display = 'block';
            }

            modal.style.display = 'flex';
        }

        // Cerrar modal de usuario
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        // Guardar usuario
        function saveUser(e) {
            e.preventDefault();

            const userId = document.getElementById('editUserId').value;
            const nombre = document.getElementById('userNombre').value;
            const apellidoPaterno = document.getElementById('userApellidoPaterno').value;
            const apellidoMaterno = document.getElementById('userApellidoMaterno').value;
            const email = document.getElementById('userEmail').value;
            const area = document.getElementById('userArea').value;
            const password = document.getElementById('userPassword').value;
            const estado = document.getElementById('userStatus').value;
            const rol = document.getElementById('userRole').value;

            if (userId) {
                // Actualizar usuario existente
                const userData = {
                    nombre: nombre,
                    apellidoPaterno: apellidoPaterno,
                    apellidoMaterno: apellidoMaterno,
                    email: email,
                    area: area,
                    estado: estado,
                    rol: rol,
                    ultimaActualizacion: new Date()
                };

                db.collection("usuarios").doc(userId).update(userData)
                    .then(() => {
                        alert('Usuario actualizado correctamente');
                        closeUserModal();
                        cargarUsuariosParaEdicion();
                    })
                    .catch(error => {
                        alert('Error al actualizar usuario: ' + error.message);
                    });
            } else {
                // Crear nuevo usuario
                if (!password) {
                    alert('La contrase침a es requerida para nuevos usuarios');
                    return;
                }

                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;

                        const userData = {
                            nombre: nombre,
                            apellidoPaterno: apellidoPaterno,
                            apellidoMaterno: apellidoMaterno,
                            email: email,
                            area: area,
                            estado: estado,
                            rol: rol,
                            ultimaActualizacion: new Date(),
                            userId: user.uid
                        };

                        return db.collection("usuarios").doc(user.uid).set(userData);
                    })
                    .then(() => {
                        alert('Usuario creado correctamente');
                        closeUserModal();
                        cargarUsuariosParaEdicion();
                        registrarMovimiento(user.uid, null, estado, "Creaci칩n de usuario", currentUser.uid);
                    })
                    .catch(error => {
                        alert('Error al crear usuario: ' + error.message);
                    });
            }
        }

        // Editar usuario
        function editUser(userId) {
            showUserModal(userId);
        }

        // Eliminar usuario
        function deleteUser(userId) {
            if (!confirm('쮼st치 seguro de que desea eliminar este usuario?')) {
                return;
            }

            db.collection("usuarios").doc(userId).delete()
                .then(() => {
                    alert('Usuario eliminado correctamente');
                    cargarUsuariosParaEdicion();
                })
                .catch(error => {
                    alert('Error al eliminar usuario: ' + error.message);
                });
        }

        // Cargar movimientos
        function cargarMovimientos() {
            const tableBody = document.getElementById('movimientos-table-body');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Cargando movimientos...</td></tr>';

            const startDate = document.getElementById('movementStartDate').valueAsDate;
            const endDate = document.getElementById('movementEndDate').valueAsDate;

            if (!startDate || !endDate) {
                alert('Por favor seleccione un rango de fechas');
                return;
            }

            // Ajustar la fecha final para incluir todo el d칤a
            endDate.setHours(23, 59, 59, 999);

            let query = db.collection("movimientos")
                .where("fecha", ">=", startDate)
                .where("fecha", "<=", endDate)
                .orderBy("fecha", "desc");

            query.get()
                .then((querySnapshot) => {
                    tableBody.innerHTML = '';

                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="7">No hay movimientos para los filtros seleccionados</td></tr>';
                        return;
                    }

                    const userIds = new Set();
                    querySnapshot.forEach(doc => {
                        const movimiento = doc.data();
                        userIds.add(movimiento.userId);
                        userIds.add(movimiento.responsableId);
                    });

                    // Obtener informaci칩n de usuarios
                    const usersPromise = Promise.all(
                        Array.from(userIds).map(userId =>
                            db.collection("usuarios").doc(userId).get()
                                .then(userDoc => ({
                                    id: userId,
                                    name: userDoc.exists ? `${userDoc.data().nombre || ''} ${userDoc.data().apellidoPaterno || ''}`.trim() : "Usuario desconocido",
                                    area: userDoc.exists ? userDoc.data().area : null
                                }))
                        )
                    );

                    usersPromise.then(users => {
                        const usersMap = new Map(users.map(user => [user.id, user]));

                        querySnapshot.forEach((doc) => {
                            const movimiento = doc.data();
                            const userInfo = usersMap.get(movimiento.userId) || { name: "Usuario desconocido", area: null };
                            const responsableInfo = usersMap.get(movimiento.responsableId) || { name: "Usuario desconocido" };
                            const fecha = movimiento.fecha ? movimiento.fecha.toDate() : new Date();

                            if (userInfo.name != "Usuario") {
                                const fila = document.createElement('tr');
                                fila.innerHTML = `
                                <td>${userInfo.name}</td>
                                <td>${userInfo.area || 'No asignada'}</td>
                                <td><span class="status ${estados[movimiento.estadoAnterior]?.clase || 'status-muestreo'}">${estados[movimiento.estadoAnterior]?.texto || 'N/A'}</span></td>
                                <td><span class="status ${estados[movimiento.estadoNuevo]?.clase || 'status-muestreo'}">${estados[movimiento.estadoNuevo]?.texto || 'N/A'}</span></td>
                                <td>${fecha.toLocaleString()}</td>
                                <td>${movimiento.ubicacion || "No registrada"}</td>
                                <td>${responsableInfo.name}</td>
                            `;

                                tableBody.appendChild(fila);
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.error("Error al cargar movimientos: ", error);
                    tableBody.innerHTML = '<tr><td colspan="7">Error al cargar los movimientos</td></tr>';
                });
        }

        // Cargar proyectos
        function loadProjects() {
            const tableBody = document.getElementById('proyectos-table-body');
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Cargando proyectos...</td></tr>';

            let query = db.collection("proyectos").orderBy("fechaCreacion", "desc");

            const statusFilter = document.getElementById('proyectosStatusFilter').value;
            if (statusFilter !== 'todos') {
                query = query.where("estado", "==", statusFilter);
            }

            query.get()
                .then((querySnapshot) => {
                    tableBody.innerHTML = '';
                    allProjects = [];

                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="9">No hay proyectos registrados</td></tr>';
                        return;
                    }

                    const usersPromise = db.collection("usuarios").get();

                    Promise.all([querySnapshot, usersPromise]).then(([projectsSnapshot, usersSnapshot]) => {
                        const usersMap = new Map();
                        usersSnapshot.forEach(doc => {
                            const userData = doc.data();
                            usersMap.set(doc.id, userData);
                        });

                        projectsSnapshot.forEach((doc) => {
                            const proyecto = doc.data();
                            proyecto.id = doc.id;
                            allProjects.push(proyecto);

                            const leaderInfo = usersMap.get(proyecto.lider) || { nombre: "Desconocido", apellidoPaterno: "" };
                            const leaderName = `${leaderInfo.nombre || ''} ${leaderInfo.apellidoPaterno || ''}`.trim();

                            let totalGastos = 0;
                            let totalIngresos = 0;

                            if (proyecto.transacciones) {
                                proyecto.transacciones.forEach(transaccion => {
                                    if (transaccion.tipo === 'expense') {
                                        totalGastos += transaccion.monto;
                                    } else if (transaccion.tipo === 'income') {
                                        totalIngresos += transaccion.monto;
                                    }
                                });
                            }

                            const saldo = totalIngresos - totalGastos;
                            const presupuesto = proyecto.presupuesto || 0;

                            const fila = document.createElement('tr');
                            fila.innerHTML = `
                            <td>${proyecto.nombre || 'N/A'}</td>
                            <td>${leaderName || 'N/A'}</td>
                            <td><span class="project-status ${proyecto.estado === 'active' ? 'status-active' : proyecto.estado === 'completed' ? 'status-completed' : 'status-cancelled'}">${proyecto.estado === 'active' ? 'Activo' : proyecto.estado === 'completed' ? 'Completado' : 'Cancelado'}</span></td>
                            <td>$${presupuesto.toFixed(2)}</td>
                            <td>$${totalGastos.toFixed(2)}</td>
                            <td>$${saldo.toFixed(2)}</td>
                            <td>${proyecto.fechaInicio ? proyecto.fechaInicio.toDate().toLocaleDateString() : 'N/A'}</td>
                            <td>${proyecto.fechaFin ? proyecto.fechaFin.toDate().toLocaleDateString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-primary" onclick="viewProject('${doc.id}')">Ver</button>
                                <button class="btn btn-secondary" onclick="editProject('${doc.id}')">Editar</button>
                                <button class="btn btn-danger" onclick="deleteProject('${doc.id}')">Eliminar</button>
                            </td>
                        `;

                            tableBody.appendChild(fila);
                        });
                    });
                })
                .catch((error) => {
                    console.error("Error al cargar proyectos: ", error);
                    tableBody.innerHTML = '<tr><td colspan="9">Error al cargar los proyectos</td></tr>';
                });
        }

        // Ver proyecto
        function viewProject(projectId) {
            currentProject = null;
            projectTransactions = [];

            // Obtener informaci칩n del proyecto
            db.collection("proyectos").doc(projectId).get()
                .then(doc => {
                    if (doc.exists) {
                        currentProject = { id: doc.id, ...doc.data() };

                        // Actualizar UI con informaci칩n del proyecto
                        document.getElementById('projectDetailTitle').textContent = currentProject.nombre;
                        document.getElementById('projectDetailDescription').textContent = currentProject.descripcion || 'Sin descripci칩n';
                        document.getElementById('projectDetailLeader').textContent = 'Cargando...';
                        document.getElementById('projectDetailStatus').innerHTML = `<span class="project-status ${currentProject.estado === 'active' ? 'status-active' : currentProject.estado === 'completed' ? 'status-completed' : 'status-cancelled'}">${currentProject.estado === 'active' ? 'Activo' : currentProject.estado === 'completed' ? 'Completado' : 'Cancelado'}</span>`;
                        document.getElementById('projectDetailStartDate').textContent = currentProject.fechaInicio ? currentProject.fechaInicio.toDate().toLocaleDateString() : 'No definida';
                        document.getElementById('projectDetailEndDate').textContent = currentProject.fechaFin ? currentProject.fechaFin.toDate().toLocaleDateString() : 'No definida';

                        // Obtener informaci칩n del l칤der
                        if (currentProject.lider) {
                            db.collection("usuarios").doc(currentProject.lider).get()
                                .then(userDoc => {
                                    if (userDoc.exists) {
                                        const userData = userDoc.data();
                                        const leaderName = `${userData.nombre || ''} ${userData.apellidoPaterno || ''}`.trim();
                                        document.getElementById('projectDetailLeader').textContent = leaderName || 'Desconocido';
                                    }
                                });
                        }

                        // Cargar transacciones del proyecto
                        cargarTransaccionesProyecto(projectId);

                        // Cambiar al m칩dulo de detalle
                        switchModule('project-detail');
                    }
                })
                .catch(error => {
                    console.error("Error al cargar proyecto:", error);
                    alert('Error al cargar el proyecto');
                });
        }

        // Cargar transacciones del proyecto
        function cargarTransaccionesProyecto(projectId) {
            const tableBody = document.getElementById('project-transactions-body');
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">Cargando transacciones...</td></tr>';

            db.collection("transacciones")
                .where("proyectoId", "==", projectId)
                .orderBy("fecha", "desc")
                .get()
                .then(querySnapshot => {
                    tableBody.innerHTML = '';
                    projectTransactions = [];
                    let totalGastos = 0;
                    let totalIngresos = 0;

                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="8">No hay transacciones registradas para este proyecto</td></tr>';
                        actualizarEstadisticasProyecto(totalIngresos, totalGastos);
                        return;
                    }

                    querySnapshot.forEach(doc => {
                        const transaccion = { id: doc.id, ...doc.data() };
                        projectTransactions.push(transaccion);

                        if (transaccion.tipo === 'gasto') {
                            totalGastos += transaccion.monto;
                        } else if (transaccion.tipo === 'ingreso') {
                            totalIngresos += transaccion.monto;
                        }

                        const fecha = transaccion.fecha ? transaccion.fecha.toDate() : new Date();
                        const categoria = transactionCategories[transaccion.tipo === 'gasto' ? 'gastos' : 'ingresos'][transaccion.categoria];
                        const categoriaNombre = categoria ? categoria.nombre : transaccion.categoria;
                        const categoriaColor = categoria ? categoria.color : '#666';

                        const fila = document.createElement('tr');
                        fila.innerHTML = `
                        <td>${fecha.toLocaleDateString()}</td>
                        <td>${transaccion.descripcion || 'Sin descripci칩n'}</td>
                        <td>
                            <span class="category-badge" style="background-color: ${categoriaColor}; color: white;">
                                ${categoriaNombre}
                            </span>
                        </td>
                        <td>
                            <span class="status ${transaccion.tipo === 'ingreso' ? 'status-oficina' : 'status-salidaSR'}">
                                ${transaccion.tipo === 'ingreso' ? 'Ingreso' : 'Gasto'}
                            </span>
                        </td>
                        <td class="${transaccion.tipo === 'ingreso' ? 'transaction-amount positive' : 'transaction-amount negative'}">
                            ${transaccion.tipo === 'ingreso' ? '+' : '-'}$${transaccion.monto.toFixed(2)}
                        </td>
                        <td>${transaccion.metodoPago || 'No especificado'}</td>
                        <td>
                            ${transaccion.comprobanteUrl ?
                                `<button class="btn btn-secondary" onclick="viewTransactionImage('${transaccion.comprobanteUrl}')">Ver Comprobante</button>` :
                                'Sin comprobante'
                            }
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="editTransaction('${doc.id}')">Editar</button>
                            <button class="btn btn-danger" onclick="deleteTransaction('${doc.id}')">Eliminar</button>
                        </td>
                    `;

                        tableBody.appendChild(fila);
                    });

                    actualizarEstadisticasProyecto(totalIngresos, totalGastos);
                    generarGraficasProyecto();
                })
                .catch(error => {
                    console.error("Error al cargar transacciones:", error);
                    tableBody.innerHTML = '<tr><td colspan="8">Error al cargar las transacciones</td></tr>';
                });
        }

        // Actualizar estad칤sticas del proyecto
        function actualizarEstadisticasProyecto(ingresos, gastos) {
            const presupuesto = currentProject.presupuesto || 0;
            const saldo = presupuesto - gastos + ingresos;

            document.getElementById('projectBudget').textContent = `$${presupuesto.toFixed(2)}`;
            document.getElementById('projectExpenses').textContent = `$${gastos.toFixed(2)}`;
            document.getElementById('projectBalance').textContent = `$${saldo.toFixed(2)}`;

            // Actualizar colores seg칰n el saldo
            const balanceElement = document.getElementById('projectBalance');
            if (saldo < 0) {
                balanceElement.style.color = '#F44336';
            } else if (saldo < presupuesto * 0.2) {
                balanceElement.style.color = '#FF9800';
            } else {
                balanceElement.style.color = '#4CAF50';
            }
        }

        // Generar gr치ficas del proyecto
        function generarGraficasProyecto() {
            // Gr치fica de distribuci칩n de gastos por categor칤a
            const gastosPorCategoria = {};
            const ingresosPorCategoria = {};
            const gastosPorMes = {};

            projectTransactions.forEach(transaccion => {
                const fecha = transaccion.fecha.toDate();
                const mes = `${fecha.getFullYear()}-${fecha.getMonth() + 1}`;

                if (transaccion.tipo === 'gasto') {
                    // Gastos por categor칤a
                    if (!gastosPorCategoria[transaccion.categoria]) {
                        gastosPorCategoria[transaccion.categoria] = 0;
                    }
                    gastosPorCategoria[transaccion.categoria] += transaccion.monto;

                    // Gastos por mes
                    if (!gastosPorMes[mes]) {
                        gastosPorMes[mes] = 0;
                    }
                    gastosPorMes[mes] += transaccion.monto;
                } else if (transaccion.tipo === 'ingreso') {
                    // Ingresos por categor칤a
                    if (!ingresosPorCategoria[transaccion.categoria]) {
                        ingresosPorCategoria[transaccion.categoria] = 0;
                    }
                    ingresosPorCategoria[transaccion.categoria] += transaccion.monto;
                }
            });

            // Gr치fica de torta - Distribuci칩n de gastos
            const categoryCtx = document.getElementById('projectCategoryChart').getContext('2d');
            if (window.projectCategoryChart) {
                window.projectCategoryChart.destroy();
            }

            const categoryLabels = Object.keys(gastosPorCategoria).map(cat => {
                const categoria = transactionCategories.gastos[cat];
                return categoria ? categoria.nombre : cat;
            });

            const categoryColors = Object.keys(gastosPorCategoria).map(cat => {
                const categoria = transactionCategories.gastos[cat];
                return categoria ? categoria.color : '#666';
            });

            window.projectCategoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: Object.values(gastosPorCategoria),
                        backgroundColor: categoryColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuci칩n de Gastos por Categor칤a'
                        }
                    }
                }
            });

            // Gr치fica de barras - Gastos vs Ingresos por mes
            const expenseCtx = document.getElementById('projectExpenseChart').getContext('2d');
            if (window.projectExpenseChart) {
                window.projectExpenseChart.destroy();
            }

            window.projectExpenseChart = new Chart(expenseCtx, {
                type: 'bar',
                data: {
                    labels: ['Gastos', 'Ingresos'],
                    datasets: [{
                        label: 'Total',
                        data: [
                            Object.values(gastosPorCategoria).reduce((a, b) => a + b, 0),
                            Object.values(ingresosPorCategoria).reduce((a, b) => a + b, 0)
                        ],
                        backgroundColor: ['#F44336', '#4CAF50'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Resumen Financiero'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Gr치fica de l칤nea - Evoluci칩n temporal
            const timelineCtx = document.getElementById('projectTimelineChart').getContext('2d');
            if (window.projectTimelineChart) {
                window.projectTimelineChart.destroy();
            }

            const meses = Object.keys(gastosPorMes).sort();
            const gastosMensuales = meses.map(mes => gastosPorMes[mes]);

            window.projectTimelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: meses.map(mes => {
                        const [year, month] = mes.split('-');
                        return `${month}/${year}`;
                    }),
                    datasets: [{
                        label: 'Gastos Mensuales',
                        data: gastosMensuales,
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evoluci칩n de Gastos Mensuales'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Mostrar modal de transacci칩n
        function showTransactionModal(transactionId = null) {
            if (!currentProject) {
                alert('No hay proyecto seleccionado');
                return;
            }

            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('transactionModalTitle');
            const form = document.getElementById('transactionForm');

            form.reset();
            document.getElementById('editTransactionId').value = '';
            document.getElementById('transactionProjectId').value = currentProject.id;
            document.getElementById('transactionDate').valueAsDate = new Date();
            document.getElementById('filePreview').innerHTML = '';

            // Cargar categor칤as iniciales
            cargarCategoriasParaSelectores('gasto');

            // Cargar tarjetas disponibles
            const cardSelect = document.getElementById('transactionCard');
            cardSelect.innerHTML = '<option value="">Seleccione una tarjeta</option>';
            financialCards.forEach(tarjeta => {
                const option = document.createElement('option');
                option.value = tarjeta.id;
                option.textContent = `${tarjeta.nombre} (${tarjeta.banco}) - Saldo: $${tarjeta.saldo.toFixed(2)}`;
                cardSelect.appendChild(option);
            });

            if (transactionId) {
                title.textContent = 'Editar Transacci칩n';

                // Cargar datos de la transacci칩n
                db.collection("transacciones").doc(transactionId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const transaccion = doc.data();
                            document.getElementById('editTransactionId').value = transactionId;
                            document.getElementById('transactionType').value = transaccion.tipo;
                            document.getElementById('transactionAmount').value = transaccion.monto;
                            document.getElementById('transactionDate').value = transaccion.fecha.toDate().toISOString().split('T')[0];
                            document.getElementById('transactionDescription').value = transaccion.descripcion || '';
                            document.getElementById('transactionPaymentMethod').value = transaccion.metodoPago || 'efectivo';

                            // Cargar categor칤as seg칰n el tipo
                            cargarCategoriasParaSelectores(transaccion.tipo);
                            document.getElementById('transactionCategory').value = transaccion.categoria;

                            // Mostrar selecci칩n de tarjeta si aplica
                            toggleCardSelection();
                            if (transaccion.tarjetaId) {
                                document.getElementById('transactionCard').value = transaccion.tarjetaId;
                            }

                            // Mostrar preview de archivo si existe
                            if (transaccion.comprobanteUrl) {
                                document.getElementById('filePreview').innerHTML = `
                                <p>Comprobante actual: <a href="${transaccion.comprobanteUrl}" target="_blank">Ver comprobante</a></p>
                            `;
                            }
                        }
                    });
            } else {
                title.textContent = 'Agregar Transacci칩n';
            }

            modal.style.display = 'flex';
        }

        // Cerrar modal de transacci칩n
        function closeTransactionModal() {
            document.getElementById('transactionModal').style.display = 'none';
        }

        // Alternar campos seg칰n tipo de transacci칩n
        function toggleTransactionFields() {
            const tipo = document.getElementById('transactionType').value;
            cargarCategoriasParaSelectores(tipo);
        }

        // Alternar selecci칩n de tarjeta
        function toggleCardSelection() {
            const metodoPago = document.getElementById('transactionPaymentMethod').value;
            const cardSection = document.getElementById('cardSelectionSection');
            cardSection.style.display = metodoPago === 'tarjeta' ? 'block' : 'none';
        }

        // Previsualizar archivo de transacci칩n
        function previewTransactionFile() {
            const fileInput = document.getElementById('transactionFile');
            const filePreview = document.getElementById('filePreview');

            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = function (e) {
                    if (file.type.startsWith('image/')) {
                        filePreview.innerHTML = `
                        <img src="${e.target.result}" class="file-preview" alt="Vista previa">
                        <p>${file.name}</p>
                    `;
                    } else {
                        filePreview.innerHTML = `
                        <p>Archivo: ${file.name}</p>
                        <p>Tipo: ${file.type}</p>
                    `;
                    }
                };

                reader.readAsDataURL(file);
            }
        }

        // Guardar transacci칩n
        function saveTransaction(e) {
            e.preventDefault();

            const transactionId = document.getElementById('editTransactionId').value;
            const projectId = document.getElementById('transactionProjectId').value;
            const tipo = document.getElementById('transactionType').value;
            const categoria = document.getElementById('transactionCategory').value;
            const monto = parseFloat(document.getElementById('transactionAmount').value);
            const fecha = new Date(document.getElementById('transactionDate').value);
            const descripcion = document.getElementById('transactionDescription').value;
            const metodoPago = document.getElementById('transactionPaymentMethod').value;
            const tarjetaId = document.getElementById('transactionCard').value;
            const fileInput = document.getElementById('transactionFile');

            if (!projectId || !tipo || !categoria || !monto || !fecha || !descripcion) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }

            const transactionData = {
                proyectoId: projectId,
                tipo: tipo,
                categoria: categoria,
                monto: monto,
                fecha: firebase.firestore.Timestamp.fromDate(fecha),
                descripcion: descripcion,
                metodoPago: metodoPago,
                usuarioId: currentUser.uid,
                fechaActualizacion: firebase.firestore.Timestamp.now()
            };

            if (metodoPago === 'tarjeta' && tarjetaId) {
                transactionData.tarjetaId = tarjetaId;

                // Obtener informaci칩n de la tarjeta
                const tarjeta = financialCards.find(card => card.id === tarjetaId);
                if (tarjeta) {
                    transactionData.tarjetaNombre = tarjeta.nombre;
                }
            }

            // Funci칩n para guardar la transacci칩n
            const guardarTransaccion = (comprobanteUrl = null) => {
                if (comprobanteUrl) {
                    transactionData.comprobanteUrl = comprobanteUrl;
                }

                if (transactionId) {
                    // Actualizar transacci칩n existente
                    db.collection("transacciones").doc(transactionId).update(transactionData)
                        .then(() => {
                            alert('Transacci칩n actualizada correctamente');
                            closeTransactionModal();
                            cargarTransaccionesProyecto(projectId);
                        })
                        .catch(error => {
                            alert('Error al actualizar transacci칩n: ' + error.message);
                        });
                } else {
                    // Crear nueva transacci칩n
                    transactionData.fechaCreacion = firebase.firestore.Timestamp.now();

                    db.collection("transacciones").add(transactionData)
                        .then(() => {
                            alert('Transacci칩n creada correctamente');
                            closeTransactionModal();
                            cargarTransaccionesProyecto(projectId);

                            // Si es un gasto con tarjeta, actualizar saldo de la tarjeta
                            if (tipo === 'gasto' && metodoPago === 'tarjeta' && tarjetaId) {
                                actualizarSaldoTarjeta(tarjetaId, -monto);
                            }
                        })
                        .catch(error => {
                            alert('Error al crear transacci칩n: ' + error.message);
                        });
                }
            };

            // Subir archivo si existe
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`comprobantes/${projectId}/${Date.now()}_${file.name}`);

                fileRef.put(file)
                    .then(snapshot => {
                        return snapshot.ref.getDownloadURL();
                    })
                    .then(downloadURL => {
                        guardarTransaccion(downloadURL);
                    })
                    .catch(error => {
                        alert('Error al subir archivo: ' + error.message);
                    });
            } else {
                guardarTransaccion();
            }
        }

        // Actualizar saldo de tarjeta
        function actualizarSaldoTarjeta(tarjetaId, monto) {
            db.collection("tarjetas").doc(tarjetaId).get()
                .then(doc => {
                    if (doc.exists) {
                        const tarjeta = doc.data();
                        const nuevoSaldo = (tarjeta.saldo || 0) + monto;

                        db.collection("tarjetas").doc(tarjetaId).update({
                            saldo: nuevoSaldo,
                            fechaActualizacion: new Date()
                        })
                            .then(() => {
                                console.log('Saldo de tarjeta actualizado');
                                loadCards(); // Recargar tarjetas para actualizar la UI
                            })
                            .catch(error => {
                                console.error('Error al actualizar saldo de tarjeta:', error);
                            });
                    }
                })
                .catch(error => {
                    console.error('Error al obtener informaci칩n de la tarjeta:', error);
                });
        }

        // Editar transacci칩n
        function editTransaction(transactionId) {
            showTransactionModal(transactionId);
        }

        // Eliminar transacci칩n
        function deleteTransaction(transactionId) {
            if (!confirm('쮼st치 seguro de que desea eliminar esta transacci칩n?')) {
                return;
            }

            db.collection("transacciones").doc(transactionId).delete()
                .then(() => {
                    alert('Transacci칩n eliminada correctamente');
                    if (currentProject) {
                        cargarTransaccionesProyecto(currentProject.id);
                    }
                })
                .catch(error => {
                    alert('Error al eliminar transacci칩n: ' + error.message);
                });
        }

        // Ver imagen de transacci칩n
        function viewTransactionImage(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').style.display = 'flex';
        }

        // Cerrar modal de imagen
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Generar reporte del proyecto
        function generateProjectReport(format) {
            if (!currentProject) {
                alert('No hay proyecto seleccionado');
                return;
            }

            if (format === 'pdf') {
                generarPDFProyecto();
            } else if (format === 'excel') {
                generarExcelProyecto();
            }
        }

        // Generar PDF del proyecto
        function generarPDFProyecto() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // T칤tulo
            doc.setFontSize(20);
            doc.text(`Reporte del Proyecto: ${currentProject.nombre}`, 20, 20);

            // Informaci칩n del proyecto
            doc.setFontSize(12);
            let y = 40;
            doc.text(`Descripci칩n: ${currentProject.descripcion || 'Sin descripci칩n'}`, 20, y);
            y += 10;
            doc.text(`Estado: ${currentProject.estado === 'active' ? 'Activo' : currentProject.estado === 'completed' ? 'Completado' : 'Cancelado'}`, 20, y);
            y += 10;
            doc.text(`Presupuesto: $${(currentProject.presupuesto || 0).toFixed(2)}`, 20, y);
            y += 10;

            // Resumen financiero
            const totalGastos = projectTransactions
                .filter(t => t.tipo === 'gasto')
                .reduce((sum, t) => sum + t.monto, 0);
            const totalIngresos = projectTransactions
                .filter(t => t.tipo === 'ingreso')
                .reduce((sum, t) => sum + t.monto, 0);
            const saldo = (currentProject.presupuesto || 0) - totalGastos + totalIngresos;

            doc.text(`Gastos Totales: $${totalGastos.toFixed(2)}`, 20, y);
            y += 10;
            doc.text(`Ingresos Totales: $${totalIngresos.toFixed(2)}`, 20, y);
            y += 10;
            doc.text(`Saldo: $${saldo.toFixed(2)}`, 20, y);
            y += 20;

            // Tabla de transacciones
            const headers = [['Fecha', 'Descripci칩n', 'Categor칤a', 'Tipo', 'Monto']];
            const data = projectTransactions.map(transaccion => {
                const fecha = transaccion.fecha.toDate().toLocaleDateString();
                const categoria = transactionCategories[transaccion.tipo === 'gasto' ? 'gastos' : 'ingresos'][transaccion.categoria];
                const categoriaNombre = categoria ? categoria.nombre : transaccion.categoria;

                return [
                    fecha,
                    transaccion.descripcion || '',
                    categoriaNombre,
                    transaccion.tipo === 'ingreso' ? 'Ingreso' : 'Gasto',
                    `$${transaccion.monto.toFixed(2)}`
                ];
            });

            doc.autoTable({
                head: headers,
                body: data,
                startY: y,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [41, 128, 185] }
            });

            doc.save(`reporte_${currentProject.nombre}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Generar Excel del proyecto
        function generarExcelProyecto() {
            // Crear workbook
            const wb = XLSX.utils.book_new();

            // Hoja de resumen
            const summaryData = [
                ['Reporte del Proyecto', currentProject.nombre],
                ['Descripci칩n', currentProject.descripcion || 'Sin descripci칩n'],
                ['Estado', currentProject.estado === 'active' ? 'Activo' : currentProject.estado === 'completed' ? 'Completado' : 'Cancelado'],
                ['Presupuesto', currentProject.presupuesto || 0],
                ['Gastos Totales', projectTransactions.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + t.monto, 0)],
                ['Ingresos Totales', projectTransactions.filter(t => t.tipo === 'ingreso').reduce((sum, t) => sum + t.monto, 0)],
                ['Saldo', (currentProject.presupuesto || 0) - projectTransactions.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + t.monto, 0) + projectTransactions.filter(t => t.tipo === 'ingreso').reduce((sum, t) => sum + t.monto, 0)],
                [''],
                ['Transacciones del Proyecto']
            ];

            const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws_summary, "Resumen");

            // Hoja de transacciones
            const transactionsData = [
                ['Fecha', 'Descripci칩n', 'Categor칤a', 'Tipo', 'Monto', 'M칠todo de Pago']
            ];

            projectTransactions.forEach(transaccion => {
                const fecha = transaccion.fecha.toDate().toLocaleDateString();
                const categoria = transactionCategories[transaccion.tipo === 'gasto' ? 'gastos' : 'ingresos'][transaccion.categoria];
                const categoriaNombre = categoria ? categoria.nombre : transaccion.categoria;

                transactionsData.push([
                    fecha,
                    transaccion.descripcion || '',
                    categoriaNombre,
                    transaccion.tipo === 'ingreso' ? 'Ingreso' : 'Gasto',
                    transaccion.monto,
                    transaccion.metodoPago || 'No especificado'
                ]);
            });

            const ws_transactions = XLSX.utils.aoa_to_sheet(transactionsData);
            XLSX.utils.book_append_sheet(wb, ws_transactions, "Transacciones");

            // Guardar archivo
            XLSX.writeFile(wb, `reporte_${currentProject.nombre}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Cerrar proyecto
        function closeProject() {
            if (!currentProject) {
                alert('No hay proyecto seleccionado');
                return;
            }

            if (!confirm('쮼st치 seguro de que desea cerrar este proyecto? Esta acci칩n no se puede deshacer.')) {
                return;
            }

            db.collection("proyectos").doc(currentProject.id).update({
                estado: 'completed',
                fechaActualizacion: firebase.firestore.Timestamp.now()
            })
                .then(() => {
                    alert('Proyecto cerrado correctamente');
                    switchModule('proyectos');
                    loadProjects();
                })
                .catch(error => {
                    alert('Error al cerrar proyecto: ' + error.message);
                });
        }

        // Mostrar modal de proyecto
        function showProjectModal(projectId = null) {
            const modal = document.getElementById('projectModal');
            const title = document.getElementById('projectModalTitle');
            const form = document.getElementById('projectForm');

            form.reset();
            document.getElementById('editProjectId').value = '';

            if (projectId) {
                title.textContent = 'Editar Proyecto';

                // Cargar datos del proyecto
                db.collection("proyectos").doc(projectId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const proyecto = doc.data();
                            document.getElementById('editProjectId').value = projectId;
                            document.getElementById('projectName').value = proyecto.nombre || '';
                            document.getElementById('projectDescription').value = proyecto.descripcion || '';
                            document.getElementById('projectLeader').value = proyecto.lider || '';
                            document.getElementById('projectBudget').value = proyecto.presupuesto || 0;
                            document.getElementById('projectStartDate').value = proyecto.fechaInicio ? proyecto.fechaInicio.toDate().toISOString().split('T')[0] : '';
                            document.getElementById('projectEndDate').value = proyecto.fechaFin ? proyecto.fechaFin.toDate().toISOString().split('T')[0] : '';

                            // Cargar participantes
                            if (proyecto.participantes) {
                                Array.from(document.getElementById('projectParticipants').options).forEach(option => {
                                    if (proyecto.participantes.includes(option.value)) {
                                        option.selected = true;
                                    }
                                });
                            }
                        }
                    });
            } else {
                title.textContent = 'Nuevo Proyecto';
                const today = new Date();
                document.getElementById('projectStartDate').valueAsDate = today;
            }

            // Cargar usuarios para l칤der y participantes
            loadUsersForProjects();

            modal.style.display = 'flex';
        }

        // Cargar usuarios para proyectos
        function loadUsersForProjects() {
            const leaderSelect = document.getElementById('projectLeader');
            const participantsSelect = document.getElementById('projectParticipants');

            leaderSelect.innerHTML = '<option value="">Seleccione un l칤der</option>';
            participantsSelect.innerHTML = '';

            db.collection("usuarios").where("nombre", "!=", "Usuario").orderBy("nombre").get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const usuario = doc.data();
                        const nombreCompleto = `${usuario.nombre || ''} ${usuario.apellidoPaterno || ''} ${usuario.apellidoMaterno || ''}`.trim();

                        // Opci칩n para l칤der
                        const optionLeader = document.createElement('option');
                        optionLeader.value = doc.id;
                        optionLeader.textContent = nombreCompleto;
                        leaderSelect.appendChild(optionLeader);

                        // Opci칩n para participantes
                        const optionParticipant = document.createElement('option');
                        optionParticipant.value = doc.id;
                        optionParticipant.textContent = nombreCompleto;
                        participantsSelect.appendChild(optionParticipant);
                    });
                })
                .catch((error) => {
                    console.error("Error al cargar usuarios para proyectos: ", error);
                });
        }

        // Cerrar modal de proyecto
        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        // Guardar proyecto
        function saveProject(e) {
            e.preventDefault();

            const projectId = document.getElementById('editProjectId').value;
            const nombre = document.getElementById('projectName').value;
            const descripcion = document.getElementById('projectDescription').value;
            const lider = document.getElementById('projectLeader').value;
            const presupuesto = parseFloat(document.getElementById('projectBudget').value);
            const fechaInicio = new Date(document.getElementById('projectStartDate').value);
            const fechaFin = document.getElementById('projectEndDate').value ? new Date(document.getElementById('projectEndDate').value) : null;

            if (!nombre || !lider || !presupuesto || !fechaInicio) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }

            const participantes = Array.from(document.getElementById('projectParticipants').selectedOptions).map(option => option.value);

            const projectData = {
                nombre: nombre,
                descripcion: descripcion || '',
                lider: lider,
                presupuesto: presupuesto,
                fechaInicio: firebase.firestore.Timestamp.fromDate(fechaInicio),
                participantes: participantes,
                estado: 'active',
                fechaActualizacion: firebase.firestore.Timestamp.now(),
                transacciones: [],
                categorias: []
            };

            if (fechaFin) {
                projectData.fechaFin = firebase.firestore.Timestamp.fromDate(fechaFin);
            }

            if (!projectId) {
                projectData.fechaCreacion = firebase.firestore.Timestamp.now();
            }

            if (projectId) {
                db.collection("proyectos").doc(projectId).update(projectData)
                    .then(() => {
                        alert('Proyecto actualizado correctamente');
                        closeProjectModal();
                        loadProjects();
                    })
                    .catch(error => {
                        alert('Error al actualizar proyecto: ' + error.message);
                    });
            } else {
                db.collection("proyectos").add(projectData)
                    .then((docRef) => {
                        alert('Proyecto creado correctamente');
                        closeProjectModal();
                        loadProjects();
                    })
                    .catch(error => {
                        alert('Error al crear proyecto: ' + error.message);
                    });
            }
        }

        // Editar proyecto
        function editProject(projectId) {
            showProjectModal(projectId);
        }

        // Eliminar proyecto
        function deleteProject(projectId) {
            if (!confirm('쮼st치 seguro de que desea eliminar este proyecto?')) {
                return;
            }

            db.collection("proyectos").doc(projectId).delete()
                .then(() => {
                    alert('Proyecto eliminado correctamente');
                    loadProjects();
                })
                .catch(error => {
                    alert('Error al eliminar proyecto: ' + error.message);
                });
        }

        // Cargar datos financieros
        function loadFinancialData() {
            // Cargar proyectos para calcular ingresos y gastos
            db.collection("proyectos").get()
                .then((querySnapshot) => {
                    let totalIncome = 0;
                    let totalExpense = 0;

                    querySnapshot.forEach((doc) => {
                        const proyecto = doc.data();

                        if (proyecto.transacciones) {
                            proyecto.transacciones.forEach(transaccion => {
                                if (transaccion.tipo === 'income') {
                                    totalIncome += transaccion.monto;
                                } else if (transaccion.tipo === 'expense') {
                                    totalExpense += transaccion.monto;
                                }
                            });
                        }
                    });

                    const totalBalance = totalIncome - totalExpense;

                    document.getElementById('totalIncome').textContent = `$${totalIncome.toFixed(2)}`;
                    document.getElementById('totalExpense').textContent = `$${totalExpense.toFixed(2)}`;
                    document.getElementById('totalBalance').textContent = `$${totalBalance.toFixed(2)}`;

                    // Generar gr치fico
                    generateFinancialChart(totalIncome, totalExpense);
                })
                .catch((error) => {
                    console.error("Error al cargar datos financieros: ", error);
                });

            // Cargar tarjetas
            loadCards();

            // Cargar efectivo disponible
            loadAvailableCash();

            // Cargar transacciones
            loadTransactions();
        }

        // Cargar tarjetas
        function loadCards() {
            const cardsContainer = document.getElementById('cardsContainer');
            cardsContainer.innerHTML = '<div class="card"><div class="card-content">Cargando tarjetas...</div></div>';

            db.collection("tarjetas").get()
                .then((querySnapshot) => {
                    financialCards = [];
                    cardsContainer.innerHTML = '';

                    if (querySnapshot.empty) {
                        cardsContainer.innerHTML = '<div class="card"><div class="card-content">No hay tarjetas registradas</div></div>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const tarjeta = doc.data();
                        tarjeta.id = doc.id;
                        financialCards.push(tarjeta);

                        const cardElement = document.createElement('div');
                        cardElement.className = 'financial-card';
                        cardElement.style.background = tarjeta.color || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

                        cardElement.innerHTML = `
                        <div class="card-header">
                            <div class="card-type">${tarjeta.banco || 'Banco'}</div>
                            <div class="card-chip"></div>
                        </div>
                        <div class="card-number">**** **** **** ${tarjeta.numero ? tarjeta.numero.slice(-4) : '****'}</div>
                        <div class="card-details">
                            <div>
                                <div>${tarjeta.nombre || 'Tarjeta'}</div>
                                <div>${tarjeta.tipo === 'debito' ? 'D칠bito' : tarjeta.tipo === 'credito' ? 'Cr칠dito' : 'Prepago'}</div>
                            </div>
                        </div>
                        <div class="card-balance">$${tarjeta.saldo ? tarjeta.saldo.toFixed(2) : '0.00'}</div>
                        <div class="card-actions">
                            <button class="btn btn-primary" onclick="addFundsToCard('${doc.id}')">Agregar</button>
                            <button class="btn btn-warning" onclick="withdrawFromCard('${doc.id}')">Retirar</button>
                            <button class="btn btn-secondary" onclick="editCard('${doc.id}')">Editar</button>
                            <button class="btn btn-danger" onclick="deleteCard('${doc.id}')">Eliminar</button>
                        </div>
                    `;

                        cardsContainer.appendChild(cardElement);
                    });
                })
                .catch((error) => {
                    console.error("Error al cargar tarjetas: ", error);
                    cardsContainer.innerHTML = '<div class="card"><div class="card-content">Error al cargar las tarjetas</div></div>';
                });
        }

        // Cargar efectivo disponible
        function loadAvailableCash() {
            db.collection("configuracion").doc("efectivo").get()
                .then(doc => {
                    if (doc.exists) {
                        availableCash = doc.data().monto || 0;
                        document.getElementById('availableCash').textContent = `$${availableCash.toFixed(2)}`;
                    } else {
                        // Crear registro por defecto
                        db.collection("configuracion").doc("efectivo").set({
                            monto: 0,
                            fechaActualizacion: new Date()
                        });
                        document.getElementById('availableCash').textContent = '$0.00';
                    }
                })
                .catch(error => {
                    console.error("Error al cargar efectivo disponible:", error);
                });
        }

        // Cargar transacciones
        function loadTransactions() {
            const tableBody = document.getElementById('transactions-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Cargando transacciones...</td></tr>';

            db.collection("transacciones").orderBy("fecha", "desc").limit(50).get()
                .then((querySnapshot) => {
                    tableBody.innerHTML = '';
                    allTransactions = [];

                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="6">No hay transacciones registradas</td></tr>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const transaccion = doc.data();
                        transaccion.id = doc.id;
                        allTransactions.push(transaccion);

                        const fecha = transaccion.fecha ? transaccion.fecha.toDate() : new Date();
                        const tipoTransaccion = transaccion.tipo === 'ingreso' ? 'Ingreso' :
                            transaccion.tipo === 'retiro' ? 'Retiro' :
                                transaccion.tipo === 'transferencia' ? 'Transferencia' : 'Otro';

                        const fila = document.createElement('tr');
                        fila.innerHTML = `
                        <td>${fecha.toLocaleString()}</td>
                        <td>${transaccion.descripcion || 'Sin descripci칩n'}</td>
                        <td>${tipoTransaccion}</td>
                        <td class="${transaccion.tipo === 'ingreso' ? 'transaction-amount positive' : 'transaction-amount negative'}">
                            ${transaccion.tipo === 'ingreso' ? '+' : '-'}$${transaccion.monto ? transaccion.monto.toFixed(2) : '0.00'}
                        </td>
                        <td>${transaccion.tarjetaNombre || 'Efectivo'}</td>
                        <td>${transaccion.proyectoNombre || 'N/A'}</td>
                    `;

                        tableBody.appendChild(fila);
                    });
                })
                .catch((error) => {
                    console.error("Error al cargar transacciones: ", error);
                    tableBody.innerHTML = '<tr><td colspan="6">Error al cargar las transacciones</td></tr>';
                });
        }

        // Mostrar modal de tarjeta
        function showCardModal(cardId = null) {
            const modal = document.getElementById('cardModal');
            const title = document.getElementById('cardModalTitle');
            const form = document.getElementById('cardForm');

            form.reset();
            document.getElementById('editCardId').value = '';

            if (cardId) {
                title.textContent = 'Editar Tarjeta';

                // Cargar datos de la tarjeta
                db.collection("tarjetas").doc(cardId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const tarjeta = doc.data();
                            document.getElementById('editCardId').value = cardId;
                            document.getElementById('cardName').value = tarjeta.nombre || '';
                            document.getElementById('cardNumber').value = tarjeta.numero || '';
                            document.getElementById('cardType').value = tarjeta.tipo || 'debito';
                            document.getElementById('cardBank').value = tarjeta.banco || '';
                            document.getElementById('cardBalance').value = tarjeta.saldo || 0;
                            document.getElementById('cardColor').value = tarjeta.color || '#3498db';
                        }
                    });
            } else {
                title.textContent = 'Agregar Tarjeta';
            }

            modal.style.display = 'flex';
        }

        // Cerrar modal de tarjeta
        function closeCardModal() {
            document.getElementById('cardModal').style.display = 'none';
        }

        // Guardar tarjeta
        function saveCard(e) {
            e.preventDefault();

            const cardId = document.getElementById('editCardId').value;
            const nombre = document.getElementById('cardName').value;
            const numero = document.getElementById('cardNumber').value;
            const tipo = document.getElementById('cardType').value;
            const banco = document.getElementById('cardBank').value;
            const saldo = parseFloat(document.getElementById('cardBalance').value);
            const color = document.getElementById('cardColor').value;

            if (!nombre || !numero || !tipo || !banco) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }

            const cardData = {
                nombre: nombre,
                numero: numero,
                tipo: tipo,
                banco: banco,
                saldo: saldo,
                color: color,
                fechaActualizacion: new Date()
            };

            if (!cardId) {
                cardData.fechaCreacion = new Date();
            }

            if (cardId) {
                db.collection("tarjetas").doc(cardId).update(cardData)
                    .then(() => {
                        alert('Tarjeta actualizada correctamente');
                        closeCardModal();
                        loadCards();
                    })
                    .catch(error => {
                        alert('Error al actualizar tarjeta: ' + error.message);
                    });
            } else {
                // Generar ID 칰nico para la tarjeta
                const newCardId = 'card_' + Date.now();

                db.collection("tarjetas").doc(newCardId).set(cardData)
                    .then(() => {
                        alert('Tarjeta creada correctamente');
                        closeCardModal();
                        loadCards();

                        // Registrar transacci칩n inicial si hay saldo
                        if (saldo > 0) {
                            registrarTransaccion({
                                tipo: 'ingreso',
                                monto: saldo,
                                descripcion: 'Saldo inicial de tarjeta',
                                tarjetaId: newCardId,
                                tarjetaNombre: nombre,
                                fecha: new Date(),
                                usuarioId: currentUser.uid
                            });
                        }
                    })
                    .catch(error => {
                        alert('Error al crear tarjeta: ' + error.message);
                    });
            }
        }

        // Editar tarjeta
        function editCard(cardId) {
            showCardModal(cardId);
        }

        // Eliminar tarjeta
        function deleteCard(cardId) {
            if (!confirm('쮼st치 seguro de que desea eliminar esta tarjeta?')) {
                return;
            }

            db.collection("tarjetas").doc(cardId).delete()
                .then(() => {
                    alert('Tarjeta eliminada correctamente');
                    loadCards();
                })
                .catch(error => {
                    alert('Error al eliminar tarjeta: ' + error.message);
                });
        }

        // Mostrar modal para agregar fondos
        function showAddFundsModal() {
            const modal = document.getElementById('addFundsModal');
            const form = document.getElementById('addFundsForm');
            const cardSelect = document.getElementById('fundsCard');

            form.reset();
            cardSelect.innerHTML = '<option value="">Seleccione una tarjeta</option>';

            // Cargar tarjetas en el selector
            financialCards.forEach(tarjeta => {
                const option = document.createElement('option');
                option.value = tarjeta.id;
                option.textContent = `${tarjeta.nombre} (${tarjeta.banco}) - Saldo: $${tarjeta.saldo ? tarjeta.saldo.toFixed(2) : '0.00'}`;
                cardSelect.appendChild(option);
            });

            modal.style.display = 'flex';
        }

        // Cerrar modal de agregar fondos
        function closeAddFundsModal() {
            document.getElementById('addFundsModal').style.display = 'none';
        }

        // Agregar fondos a tarjeta
        function addFundsToCard(cardId = null) {
            if (cardId) {
                // Si se llama desde un bot칩n espec칤fico, seleccionar esa tarjeta
                showAddFundsModal();
                setTimeout(() => {
                    document.getElementById('fundsCard').value = cardId;
                }, 100);
                return;
            }

            // Si se llama desde el formulario
            const form = document.getElementById('addFundsForm');
            const cardIdFromForm = document.getElementById('fundsCard').value;
            const monto = parseFloat(document.getElementById('fundsAmount').value);
            const descripcion = document.getElementById('fundsDescription').value || 'Dep칩sito de fondos';

            if (!cardIdFromForm || !monto || monto <= 0) {
                alert('Por favor complete todos los campos correctamente');
                return;
            }

            // Obtener informaci칩n de la tarjeta
            db.collection("tarjetas").doc(cardIdFromForm).get()
                .then(doc => {
                    if (doc.exists) {
                        const tarjeta = doc.data();
                        const nuevoSaldo = (tarjeta.saldo || 0) + monto;

                        // Actualizar saldo de la tarjeta
                        db.collection("tarjetas").doc(cardIdFromForm).update({
                            saldo: nuevoSaldo,
                            fechaActualizacion: new Date()
                        })
                            .then(() => {
                                // Registrar transacci칩n
                                registrarTransaccion({
                                    tipo: 'ingreso',
                                    monto: monto,
                                    descripcion: descripcion,
                                    tarjetaId: cardIdFromForm,
                                    tarjetaNombre: tarjeta.nombre,
                                    fecha: new Date(),
                                    usuarioId: currentUser.uid
                                });

                                alert('Fondos agregados correctamente');
                                closeAddFundsModal();
                                loadCards();
                                loadTransactions();
                            })
                            .catch(error => {
                                alert('Error al agregar fondos: ' + error.message);
                            });
                    }
                })
                .catch(error => {
                    alert('Error al obtener informaci칩n de la tarjeta: ' + error.message);
                });
        }

        // Mostrar modal para retirar efectivo
        function showWithdrawModal(cardId = null) {
            const modal = document.getElementById('withdrawModal');
            const form = document.getElementById('withdrawForm');
            const cardSelect = document.getElementById('withdrawCard');
            const projectSelect = document.getElementById('withdrawProject');

            form.reset();
            cardSelect.innerHTML = '<option value="">Seleccione una tarjeta</option>';
            projectSelect.innerHTML = '<option value="">Seleccione un proyecto</option>';

            // Cargar tarjetas en el selector
            financialCards.forEach(tarjeta => {
                const option = document.createElement('option');
                option.value = tarjeta.id;
                option.textContent = `${tarjeta.nombre} (${tarjeta.banco}) - Saldo: $${tarjeta.saldo ? tarjeta.saldo.toFixed(2) : '0.00'}`;
                cardSelect.appendChild(option);
            });

            // Cargar proyectos en el selector
            db.collection("proyectos").where("estado", "==", "active").get()
                .then(querySnapshot => {
                    querySnapshot.forEach(doc => {
                        const proyecto = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = proyecto.nombre;
                        projectSelect.appendChild(option);
                    });
                });

            if (cardId) {
                // Si se llama desde un bot칩n espec칤fico, seleccionar esa tarjeta
                setTimeout(() => {
                    document.getElementById('withdrawCard').value = cardId;
                }, 100);
            }

            modal.style.display = 'flex';
        }

        // Cerrar modal de retiro
        function closeWithdrawModal() {
            document.getElementById('withdrawModal').style.display = 'none';
        }

        // Retirar efectivo de tarjeta
        function withdrawFromCard(cardId = null) {
            if (cardId) {
                // Si se llama desde un bot칩n espec칤fico, seleccionar esa tarjeta
                showWithdrawModal(cardId);
                return;
            }

            // Si se llama desde el formulario
            const form = document.getElementById('withdrawForm');
            const cardIdFromForm = document.getElementById('withdrawCard').value;
            const monto = parseFloat(document.getElementById('withdrawAmount').value);
            const descripcion = document.getElementById('withdrawDescription').value || 'Retiro de efectivo';
            const proyectoId = document.getElementById('withdrawProject').value;

            if (!cardIdFromForm || !monto || monto <= 0) {
                alert('Por favor complete todos los campos correctamente');
                return;
            }

            // Obtener informaci칩n de la tarjeta
            db.collection("tarjetas").doc(cardIdFromForm).get()
                .then(doc => {
                    if (doc.exists) {
                        const tarjeta = doc.data();
                        const saldoActual = tarjeta.saldo || 0;

                        if (monto > saldoActual) {
                            alert('El monto a retirar excede el saldo disponible en la tarjeta');
                            return;
                        }

                        const nuevoSaldo = saldoActual - monto;

                        // Actualizar saldo de la tarjeta
                        db.collection("tarjetas").doc(cardIdFromForm).update({
                            saldo: nuevoSaldo,
                            fechaActualizacion: new Date()
                        })
                            .then(() => {
                                // Actualizar efectivo disponible
                                const nuevoEfectivo = availableCash + monto;
                                db.collection("configuracion").doc("efectivo").update({
                                    monto: nuevoEfectivo,
                                    fechaActualizacion: new Date()
                                })
                                    .then(() => {
                                        availableCash = nuevoEfectivo;
                                        document.getElementById('availableCash').textContent = `$${nuevoEfectivo.toFixed(2)}`;

                                        // Registrar transacci칩n
                                        const transaccionData = {
                                            tipo: 'retiro',
                                            monto: monto,
                                            descripcion: descripcion,
                                            tarjetaId: cardIdFromForm,
                                            tarjetaNombre: tarjeta.nombre,
                                            fecha: new Date(),
                                            usuarioId: currentUser.uid
                                        };

                                        if (proyectoId) {
                                            transaccionData.proyectoId = proyectoId;

                                            // Obtener nombre del proyecto
                                            db.collection("proyectos").doc(proyectoId).get()
                                                .then(proyectoDoc => {
                                                    if (proyectoDoc.exists) {
                                                        transaccionData.proyectoNombre = proyectoDoc.data().nombre;
                                                    }
                                                    registrarTransaccion(transaccionData);
                                                });
                                        } else {
                                            registrarTransaccion(transaccionData);
                                        }

                                        alert('Efectivo retirado correctamente');
                                        closeWithdrawModal();
                                        loadCards();
                                        loadTransactions();
                                    })
                                    .catch(error => {
                                        alert('Error al actualizar efectivo disponible: ' + error.message);
                                    });
                            })
                            .catch(error => {
                                alert('Error al retirar efectivo: ' + error.message);
                            });
                    }
                })
                .catch(error => {
                    alert('Error al obtener informaci칩n de la tarjeta: ' + error.message);
                });
        }

        // Registrar transacci칩n
        function registrarTransaccion(transaccionData) {
            db.collection("transacciones").add(transaccionData)
                .then(() => {
                    console.log('Transacci칩n registrada correctamente');
                })
                .catch(error => {
                    console.error('Error al registrar transacci칩n:', error);
                });
        }

        // Generar gr치fico financiero
        function generateFinancialChart(income, expense) {
            const ctx = document.getElementById('financialChart').getContext('2d');

            // Destruir gr치fico existente si existe
            if (window.financialChart) {
                window.financialChart.destroy();
            }

            window.financialChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ingresos', 'Gastos'],
                    datasets: [{
                        data: [income, expense],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.7)',
                            'rgba(244, 67, 54, 0.7)'
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(244, 67, 54, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Distribuci칩n Financiera'
                        }
                    }
                }
            });
        }

        // Cargar 치reas
        function cargarAreas() {
            const tableBody = document.getElementById('areas-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Cargando 치reas...</td></tr>';

            db.collection("areas").get()
                .then((querySnapshot) => {
                    tableBody.innerHTML = '';

                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="4">No hay 치reas registradas</td></tr>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const area = doc.data();
                        area.id = doc.id;

                        // Contar usuarios en esta 치rea
                        db.collection("usuarios").where("area", "==", doc.id).get()
                            .then((userSnapshot) => {
                                const numUsuarios = userSnapshot.size;

                                const fila = document.createElement('tr');
                                fila.innerHTML = `
                                <td>${area.nombre}</td>
                                <td>
                                    <span style="display: inline-block; width: 20px; height: 20px; border-radius: 50%; background-color: ${area.color};"></span>
                                    ${area.color}
                                </td>
                                <td>${numUsuarios}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="editArea('${doc.id}')">Editar</button>
                                    <button class="btn btn-danger" onclick="deleteArea('${doc.id}')">Eliminar</button>
                                </td>
                            `;

                                tableBody.appendChild(fila);
                            });
                    });
                })
                .catch((error) => {
                    console.error("Error al cargar 치reas: ", error);
                    tableBody.innerHTML = '<tr><td colspan="4">Error al cargar las 치reas</td></tr>';
                });
        }

        // Mostrar modal de 치rea
        function showAreaModal(areaId = null) {
            const modal = document.getElementById('areaModal');
            const title = document.getElementById('areaModalTitle');
            const form = document.getElementById('areaForm');

            form.reset();
            document.getElementById('editAreaId').value = '';

            if (areaId) {
                title.textContent = 'Editar 츼rea';

                // Cargar datos del 치rea
                db.collection("areas").doc(areaId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const area = doc.data();
                            document.getElementById('editAreaId').value = areaId;
                            document.getElementById('areaName').value = area.nombre || '';
                            document.getElementById('areaColor').value = area.color || '#3498db';
                        }
                    });
            } else {
                title.textContent = 'Agregar 츼rea';
            }

            modal.style.display = 'flex';
        }

        // Cerrar modal de 치rea
        function closeAreaModal() {
            document.getElementById('areaModal').style.display = 'none';
        }

        // Guardar 치rea
        function saveArea(e) {
            e.preventDefault();

            const areaId = document.getElementById('editAreaId').value;
            const nombre = document.getElementById('areaName').value;
            const color = document.getElementById('areaColor').value;

            if (!nombre) {
                alert('Por favor ingrese un nombre para el 치rea');
                return;
            }

            const areaData = {
                nombre: nombre,
                color: color,
                fechaActualizacion: new Date()
            };

            if (!areaId) {
                areaData.fechaCreacion = new Date();
            }

            if (areaId) {
                db.collection("areas").doc(areaId).update(areaData)
                    .then(() => {
                        alert('츼rea actualizada correctamente');
                        closeAreaModal();
                        cargarAreas();
                        cargarAreasParaSelectores();
                    })
                    .catch(error => {
                        alert('Error al actualizar 치rea: ' + error.message);
                    });
            } else {
                // Generar ID 칰nico para el 치rea
                const newAreaId = nombre.toLowerCase().replace(/\s+/g, '_');

                db.collection("areas").doc(newAreaId).set(areaData)
                    .then(() => {
                        alert('츼rea creada correctamente');
                        closeAreaModal();
                        cargarAreas();
                        cargarAreasParaSelectores();
                    })
                    .catch(error => {
                        alert('Error al crear 치rea: ' + error.message);
                    });
            }
        }

        // Editar 치rea
        function editArea(areaId) {
            showAreaModal(areaId);
        }

        // Eliminar 치rea
        function deleteArea(areaId) {
            if (!confirm('쮼st치 seguro de que desea eliminar esta 치rea?')) {
                return;
            }

            // Verificar si hay usuarios en esta 치rea
            db.collection("usuarios").where("area", "==", areaId).get()
                .then(querySnapshot => {
                    if (querySnapshot.size > 0) {
                        alert('No se puede eliminar el 치rea porque tiene usuarios asignados. Reasigne los usuarios primero.');
                        return;
                    }

                    db.collection("areas").doc(areaId).delete()
                        .then(() => {
                            alert('츼rea eliminada correctamente');
                            cargarAreas();
                            cargarAreasParaSelectores();
                        })
                        .catch(error => {
                            alert('Error al eliminar 치rea: ' + error.message);
                        });
                })
                .catch(error => {
                    alert('Error al verificar usuarios: ' + error.message);
                });
        }

        // Funci칩n para cambiar entre vistas
        function changeView(viewType) {
            currentView = viewType;

            // Actualizar botones activos
            document.querySelectorAll('.view-controls .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewType}"]`).classList.add('active');

            // Mostrar/ocultar vistas
            document.getElementById('cardsGridView').classList.toggle('active', viewType === 'grid');
            document.getElementById('cardsListView').classList.toggle('active', viewType === 'list');

            // Recargar datos si es necesario
            if (document.getElementById('vista-cartas-module').classList.contains('active')) {
                loadUsersCards();
            }
        }

        // Funci칩n para cargar usuarios en vista de cartas
        function loadUsersCards() {
            const gridContainer = document.getElementById('usersCardsGrid');
            const listContainer = document.getElementById('usersCardsList');

            // Mostrar estado de carga
            gridContainer.innerHTML = `
        <div class="loading-cards">
            <div class="loading-spinner"></div>
            <p>Cargando usuarios...</p>
        </div>
    `;
            listContainer.innerHTML = `
        <div class="loading-cards">
            <div class="loading-spinner"></div>
            <p>Cargando usuarios...</p>
        </div>
    `;

            const areaFilter = document.getElementById('cardsAreaFilter').value;
            const statusFilter = document.getElementById('cardsStatusFilter').value;

            let query = db.collection("usuarios").where("nombre", "!=", "Usuario");

            if (areaFilter !== 'todos') {
                query = query.where("area", "==", areaFilter);
            }

            query.get()
                .then((querySnapshot) => {
                    gridContainer.innerHTML = '';
                    listContainer.innerHTML = '';

                    if (querySnapshot.empty) {
                        const emptyHTML = `
                    <div class="empty-state-cards">
                        <p>No hay usuarios registrados</p>
                        <p class="empty-subtitle">Intenta cambiar los filtros</p>
                    </div>
                `;
                        gridContainer.innerHTML = emptyHTML;
                        listContainer.innerHTML = emptyHTML;
                        return;
                    }

                    let hasUsers = false;

                    querySnapshot.forEach((doc) => {
                        const usuario = doc.data();

                        // Aplicar filtro de estado
                        if (statusFilter !== 'todos' && usuario.estado !== statusFilter) {
                            return;
                        }

                        hasUsers = true;
                        usuario.id = doc.id;

                        // Crear tarjeta para vista grid
                        const gridCard = createUserCard(usuario, 'grid');
                        gridContainer.appendChild(gridCard);

                        // Crear tarjeta para vista lista
                        const listCard = createUserCard(usuario, 'list');
                        listContainer.appendChild(listCard);
                    });

                    if (!hasUsers) {
                        const emptyHTML = `
                    <div class="empty-state-cards">
                        <p>No hay usuarios con los filtros seleccionados</p>
                        <button class="btn btn-primary" onclick="document.getElementById('cardsAreaFilter').value='todos'; document.getElementById('cardsStatusFilter').value='todos'; loadUsersCards();">
                            Mostrar todos
                        </button>
                    </div>
                `;
                        gridContainer.innerHTML = emptyHTML;
                        listContainer.appendChild(document.createElement('div')).innerHTML = emptyHTML;
                    }
                })
                .catch((error) => {
                    console.error("Error al cargar usuarios: ", error);
                    const errorHTML = `
                <div class="empty-state-cards">
                    <p>Error al cargar los usuarios</p>
                    <button class="btn btn-primary" onclick="loadUsersCards()">
                        Reintentar
                    </button>
                </div>
            `;
                    gridContainer.innerHTML = errorHTML;
                    listContainer.innerHTML = errorHTML;
                });
        }

        // Funci칩n para crear tarjeta de usuario
        function createUserCard(usuario, viewType) {
            const card = document.createElement('div');
            card.className = `user-card ${viewType}-view status-${usuario.estado}`;

            const estadoInfo = estados[usuario.estado] || estados.muestreo;
            const fecha = usuario.ultimaActualizacion ? usuario.ultimaActualizacion.toDate() : new Date();
            const nombreCompleto = `${usuario.nombre || ''} ${usuario.apellidoPaterno || ''} ${usuario.apellidoMaterno || ''}`.trim();

            if (viewType === 'grid') {
                card.innerHTML = `
            <div class="user-card-header">
                <div class="user-card-info">
                    <div class="user-card-name">${nombreCompleto || 'Usuario'}</div>
                    <div class="user-card-email">${usuario.email || 'N/A'}</div>
                    <div class="user-card-area">${usuario.area || 'No asignada'}</div>
                </div>
            </div>
            <div class="user-card-status">
                <span class="user-card-current-status ${estadoInfo.clase}">
                    ${estadoInfo.texto}
                </span>
            </div>
            <div class="user-card-location">
                ${usuario.ubicacion || 'Ubicaci칩n no disponible'}
            </div>
            <div class="user-card-time">
                ${fecha.toLocaleTimeString()}
            </div>
            <div class="user-card-actions grid-view">
                <button class="quick-status-btn" onclick="openQuickStatusModal('${usuario.id}')">
                    Cambiar Estado
                </button>
            </div>
        `;
            } else {
                // Vista lista
                card.innerHTML = `
            <div class="user-card-info">
                <div class="user-card-name">${nombreCompleto || 'Usuario'}</div>
                <div class="user-card-email">${usuario.email || 'N/A'}</div>
            </div>
            <div class="user-card-status">
                <span class="user-card-current-status ${estadoInfo.clase}">
                    ${estadoInfo.texto}
                </span>
            </div>
            <div class="user-card-actions list-view">
                <button class="quick-status-btn" onclick="openQuickStatusModal('${usuario.id}')">
                    Cambiar
                </button>
            </div>
        `;
            }

            return card;
        }

        // Funci칩n para abrir modal r치pido de cambio de estado
        function openQuickStatusModal(userId) {
            currentQuickUser = userId;

            db.collection("usuarios").doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const usuario = doc.data();
                        const estadoInfo = estados[usuario.estado] || estados.muestreo;
                        const nombreCompleto = `${usuario.nombre || ''} ${usuario.apellidoPaterno || ''} ${usuario.apellidoMaterno || ''}`.trim();

                        document.getElementById('quickStatusUserName').textContent = `Cambiar Estado - ${nombreCompleto}`;
                        document.getElementById('currentUserStatus').textContent = estadoInfo.texto;
                        document.getElementById('currentUserStatus').className = `status-badge ${estadoInfo.clase}`;
                        document.getElementById('currentUserLocation').textContent = `Ubicaci칩n: ${usuario.ubicacion || 'No disponible'}`;

                        // Generar botones de estado
                        const buttonsContainer = document.getElementById('quickStatusButtons');
                        buttonsContainer.innerHTML = '';

                        Object.keys(estados).forEach(key => {
                            const estado = estados[key];
                            if (key !== usuario.estado) { // No mostrar el estado actual
                                const button = document.createElement('button');
                                button.type = 'button';
                                button.className = 'quick-status-btn-modal';
                                button.style.backgroundColor = estado.color;
                                button.innerHTML = estado.texto;
                                button.onclick = () => quickChangeStatus(key);

                                buttonsContainer.appendChild(button);
                            }
                        });

                        document.getElementById('quickStatusModal').style.display = 'flex';
                    }
                })
                .catch(error => {
                    console.error("Error al cargar usuario:", error);
                    alert("Error al cargar informaci칩n del usuario");
                });
        }

        // Funci칩n para cerrar modal r치pido
        function closeQuickStatusModal() {
            document.getElementById('quickStatusModal').style.display = 'none';
            currentQuickUser = null;
        }

        // Funci칩n para cambio r치pido de estado
        function quickChangeStatus(nuevoEstado) {
            if (!currentQuickUser) return;

            obtenerUbicacion().then(ubicacion => {
                db.collection("usuarios").doc(currentQuickUser).get()
                    .then(doc => {
                        if (doc.exists) {
                            const usuario = doc.data();
                            const estadoAnterior = usuario.estado;

                            db.collection("usuarios").doc(currentQuickUser).update({
                                estado: nuevoEstado,
                                ultimaActualizacion: new Date(),
                                ubicacion: ubicacion
                            })
                                .then(() => {
                                    // Registrar movimiento
                                    registrarMovimiento(
                                        currentQuickUser,
                                        estadoAnterior,
                                        nuevoEstado,
                                        "Cambio r치pido desde vista cartas",
                                        currentUser.uid
                                    );

                                    // Cerrar modal y recargar
                                    closeQuickStatusModal();
                                    loadUsersCards();

                                    // Mostrar notificaci칩n
                                    showNotification(`Estado cambiado a: ${estados[nuevoEstado].texto}`, 'success');
                                })
                                .catch(error => {
                                    console.error("Error al cambiar estado:", error);
                                    showNotification("Error al cambiar estado", 'error');
                                });
                        }
                    });
            }).catch(error => {
                console.error("Error al obtener ubicaci칩n:", error);
                // Cambiar estado sin ubicaci칩n
                db.collection("usuarios").doc(currentQuickUser).update({
                    estado: nuevoEstado,
                    ultimaActualizacion: new Date()
                })
                    .then(() => {
                        closeQuickStatusModal();
                        loadUsersCards();
                        showNotification(`Estado cambiado a: ${estados[nuevoEstado].texto}`, 'success');
                    });
            });
        }

        // Funci칩n para obtener ubicaci칩n actual
        function getCurrentLocation() {
            obtenerUbicacion().then(ubicacion => {
                document.getElementById('currentUserLocation').textContent = `Ubicaci칩n: ${ubicacion}`;
                showNotification('Ubicaci칩n actualizada', 'success');
            }).catch(error => {
                showNotification('Error al obtener ubicaci칩n', 'error');
            });
        }

        // Funci칩n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            // Crear elemento de notificaci칩n
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
        </div>
    `;

            // Estilos para la notificaci칩n
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        max-width: 300px;
    `;

            document.body.appendChild(notification);

            // Auto-remover despu칠s de 3 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // Generar PDF
        function generarPDF(tipo) {
            alert(`Generando PDF para ${tipo}...`);
            // Implementar generaci칩n de PDF seg칰n el tipo
        }

        // Generar Excel
        function generarExcel(tipo) {
            alert(`Generando Excel para ${tipo}...`);
            // Implementar generaci칩n de Excel seg칰n el tipo
        }

        // Inicializar la aplicaci칩n cuando se carga la p치gina
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
